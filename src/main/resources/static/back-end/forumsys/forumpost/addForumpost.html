<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增文章 - 論壇文章管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
          integrity="sha512-Fo3rlrNjHq3R8U6/S3A7+wP9m/8M+2yF8zN4Fp9J5N6d5qKj5K5f5A7f5D5f5+5G5+5Q5+5g5+5h5+5Q=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <style>
        /* CSS 樣式區：定義頁面外觀與排版 (保持與你提供的一致) */
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0 auto;
            max-width: 800px;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        h1 {
            color: #2c3e50;
            margin: 0;
        }

        .form-container { /* 修改 class 名稱以與 HTML 匹配 */
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #34495e;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box; /* 確保 padding 不增加寬度 */
        }

        .btn {
            display: inline-block;
            text-decoration: none;
            color: white;
            padding: 10px 18px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-submit {
            background-color: #27ae60; /* 綠色 */
        }

        .btn-back {
            background-color: #95a5a6; /* 灰色 */
        }

        .form-actions {
            text-align: right;
            margin-top: 30px;
        }

        .form-actions .btn {
            margin-left: 10px;
        }

        #message-area {
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            display: none; /* 預設隱藏 */
            font-weight: bold;
        }

        #message-area.success {
            color: #155724;
            background-color: #d4edda;
        }

        #message-area.error {
            color: #721c24;
            background-color: #f8d7da;
        }

        /* 預設圖片預覽樣式 */
        #defaultImagePreview {
            max-width: 150px;
            max-height: 150px;
            margin-top: 10px;
            border: 1px solid #ddd;
            display: none; /* 預設隱藏 */
        }
    </style>
</head>
<body>
<div class="header-container">
    <h1>新增文章</h1></div>

<div class="form-container">
    <form id="add-forumpost-form">
        <div class="form-group">
            <label for="postTitle">文章標題</label>
            <input type="text" id="postTitle" name="postTitle" required maxlength="50">
        </div>

        <div class="form-group">
            <label for="postCon">文章內容</label>
            <textarea id="postCon" name="postCon" required rows="10" minlength="10" maxlength="5000"></textarea>
        </div>

        <div class="form-group">
            <label for="forNoId">所屬討論區</label>
            <select id="forNoId" name="forNoId" required>
                <option value="" disabled selected>--載入中--</option>
            </select>
        </div>

        <div class="form-group">
            <label for="ftagNoId">文章類別</label>
            <select id="ftagNoId" name="ftagNoId" required>
                <option value="" disabled selected>--載入中--</option>
            </select>
        </div>

        <div class="form-group">
            <label>文章封面圖片</label>
            <div>
                <input type="radio" id="useDefaultImage" name="imageSource" value="default" checked>
                <label for="useDefaultImage">使用預設圖片</label>
            </div>
            <div>
                <input type="radio" id="uploadCustomImage" name="imageSource" value="custom">
                <label for="uploadCustomImage">上傳自訂圖片</label>
            </div>

            <img id="defaultImagePreview" src="" alt="預設圖片預覽" style="display: none;">
            <input type="file" id="postCoverImageFile" name="imageFile" accept="image/*" style="display: none;">
        </div>

        <div class="form-actions">
            <a href="/back-end/forumsys/forumpost/allForumPost.html" class="btn btn-back">返回列表</a>
            <button type="submit" id="submit-button" class="btn btn-submit">確認新增</button>
        </div>
    </form>
</div>

<div id="message-area"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const postTitleInput = document.getElementById('postTitle');
        const postConTextarea = document.getElementById('postCon');
        const forNoSelect = document.getElementById('forNoId');
        const ftagNoSelect = document.getElementById('ftagNoId');

        const useDefaultImageRadio = document.getElementById('useDefaultImage');
        const uploadCustomImageRadio = document.getElementById('uploadCustomImage');
        const defaultImagePreview = document.getElementById('defaultImagePreview');
        const postCoverImageFileInput = document.getElementById('postCoverImageFile');

        const form = document.getElementById('add-forumpost-form');
        const submitButton = document.getElementById('submit-button');
        const messageArea = document.getElementById('message-area');

        const API_ADD_POST_URL = 'http://localhost:8080/api/forumpost/insert';
        const API_FORUMS_URL = 'http://localhost:8080/api/forums';
        const API_FORUM_TAGS_URL = 'http://localhost:8080/api/forumtag';

        // 定義預設圖片的映射關係
        // 假設您的圖片都放在 /resources/imgseed/forumposttag_img/
        // 並以文章類別 ID 作為檔案名 (例如 1.jpg, 2.jpg 等)
        const DEFAULT_IMAGE_BASE_PATH = '/resources/imgseed/forumposttag_img/';
        const DEFAULT_IMAGE_MAP = {
            // 範例：映射類別 ID 到圖片名稱
            // 這些 ID 和圖片名稱需要根據您的實際情況進行配置
            1: '01.jpg',
            2: '02.jpg',
            3: '03.jpg',
            4: '04.jpg',
            5: '05.jpg',
            6: '06.jpg',
            7: '07.jpg',
            8: '08.jpg',
            9: '09.jpg',
            10: '10.jpg',
            11: '11.jpg',
            // ... 可以繼續添加更多映射
        };

        let selectedDefaultImageUrl = ''; // 用於儲存當前選定的預設圖片 URL

        function showMessage(message, type) {
            messageArea.innerHTML = message;
            messageArea.className = type;
            messageArea.style.display = 'block';
        }

        function hideMessage() {
            messageArea.style.display = 'none';
            messageArea.textContent = '';
        }

        async function loadForums() {
            try {
                const response = await fetch(API_FORUMS_URL);
                if (!response.ok) {
                    throw new Error(`無法載入討論區資料，狀態碼: ${response.status}`);
                }
                const forums = await response.json();

                forNoSelect.innerHTML = '<option value="" disabled selected>--請選擇討論區--</option>';
                forums.forEach(forum => {
                    const option = document.createElement('option');
                    option.value = forum.id;
                    option.textContent = forum.forName;
                    forNoSelect.appendChild(option);
                });
            } catch (error) {
                console.error('載入討論區失敗:', error);
                forNoSelect.innerHTML = '<option value="" disabled>討論區載入失敗</option>';
                showMessage(`載入討論區失敗: ${error.message}`, 'error');
            }
        }

        async function loadForumTags() {
            try {
                const response = await fetch(API_FORUM_TAGS_URL);
                if (!response.ok) {
                    throw new Error(`無法載入文章類別資料，狀態碼: ${response.status}`);
                }
                const tags = await response.json();

                ftagNoSelect.innerHTML = '<option value="" disabled selected>--請選擇文章類別--</option>';
                tags.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.ftagName;
                    option.dataset.defaultImage = DEFAULT_IMAGE_MAP[tag.id] || ''; // 將預設圖片名存儲在 dataset
                    ftagNoSelect.appendChild(option);
                });
                // 載入完畢後，如果已經有選定的文章類別，觸發一次預覽更新
                updateDefaultImagePreview();

            } catch (error) {
                console.error('載入文章類別失敗:', error);
                ftagNoSelect.innerHTML = '<option value="" disabled>文章類別載入失敗</option>';
                showMessage(`載入文章類別失敗: ${error.message}`, 'error');
            }
        }

        // --- 處理圖片來源選擇 (預設圖片 vs. 自訂上傳) ---
        function handleImageSourceChange() {
            if (useDefaultImageRadio.checked) {
                postCoverImageFileInput.style.display = 'none';
                postCoverImageFileInput.value = ''; // 清空已選擇的自訂檔案
                updateDefaultImagePreview(); // 顯示預設圖片預覽
            } else { // uploadCustomImageRadio.checked
                defaultImagePreview.style.display = 'none';
                defaultImagePreview.src = ''; // 清空預覽圖片
                postCoverImageFileInput.style.display = 'block';
            }
        }

        // --- 根據選定的文章類別更新預設圖片預覽 ---
        function updateDefaultImagePreview() {
            const selectedOption = ftagNoSelect.options[ftagNoSelect.selectedIndex];
            const defaultImageName = selectedOption ? selectedOption.dataset.defaultImage : '';

            if (useDefaultImageRadio.checked && defaultImageName) {
                selectedDefaultImageUrl = DEFAULT_IMAGE_BASE_PATH + defaultImageName;
                defaultImagePreview.src = selectedDefaultImageUrl;
                defaultImagePreview.style.display = 'block';
            } else {
                selectedDefaultImageUrl = '';
                defaultImagePreview.src = '';
                defaultImagePreview.style.display = 'none';
            }
        }

        // --- 事件監聽器 ---
        ftagNoSelect.addEventListener('change', updateDefaultImagePreview); // 文章類別改變時更新預覽
        useDefaultImageRadio.addEventListener('change', handleImageSourceChange);
        uploadCustomImageRadio.addEventListener('change', handleImageSourceChange);


        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            hideMessage();

            submitButton.disabled = true;
            submitButton.textContent = '新增中...';

            const formData = new FormData();

            // 構建 ForumPostUpdateDTO 對象（用於後端接收 JSON 數據）
            const forumPostUpdateDTO = {
                forNoId: parseInt(forNoSelect.value),
                ftagNoId: parseInt(ftagNoSelect.value),
                postTitle: postTitleInput.value.trim(),
                postCon: postConTextarea.value.trim(),
                postPin: '0', // 預設為 '0' (不置頂)
                postStatus: '1' // 預設為 '1' (公開)
            };

            // 將 DTO 物件轉換為 JSON 字串並作為 Blob 添加到 FormData 中
            // 這裡的 'forumPostUpdate' 必須與後端 Controller @RequestPart("forumPostUpdate") 的名稱匹配
            formData.append('forumPostUpdate', new Blob([JSON.stringify(forumPostUpdateDTO)], {type: 'application/json'}));

            // 處理圖片上傳或預設圖片 URL
            if (uploadCustomImageRadio.checked && postCoverImageFileInput.files.length > 0) {
                // 用戶選擇了上傳自訂圖片
                formData.append('imageFile', postCoverImageFileInput.files[0]);
            } else if (useDefaultImageRadio.checked && selectedDefaultImageUrl) {
                // 用戶選擇使用預設圖片，並且有選定的預設圖片 URL
                // 後端需要一個新的 RequestPart 參數來接收這個 URL
                // 或者 Service 層自行根據 ftagNoId 判斷並設定圖片
                // 這裡的實現將預設圖片URL作為一個額外的 RequestPart 傳遞
                formData.append('defaultImageUrl', selectedDefaultImageUrl);
            }
            // 如果都沒有選擇，則不傳遞圖片相關參數

            console.log("提交的 FormData (DTO部分):", forumPostUpdateDTO);
            if (uploadCustomImageRadio.checked) {
                console.log("提交的 FormData (自訂圖片):", postCoverImageFileInput.files[0]);
            } else if (useDefaultImageRadio.checked) {
                console.log("提交的 FormData (預設圖片URL):", selectedDefaultImageUrl);
            }


            try {
                const response = await fetch(API_ADD_POST_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorResponse = await response.json().catch(() => ({message: `發生錯誤，狀態碼: ${response.status}`}));
                    const errorMessage = Object.values(errorResponse).flat().join('<br>');
                    throw new Error(errorMessage || `發生錯誤，狀態碼: ${response.status}`);
                }

                showMessage('文章新增成功！2秒後將返回文章列表頁。', 'success');
                form.reset();
                defaultImagePreview.style.display = 'none'; // 重置時隱藏圖片
                selectedDefaultImageUrl = ''; // 清空預設圖片URL
                // 確保電台按鈕和文件輸入狀態正確重置
                useDefaultImageRadio.checked = true;
                postCoverImageFileInput.style.display = 'none';


                setTimeout(() => {
                    window.location.href = '/back-end/forumsys/forumpost/allForumPost.html';
                }, 2000);

            } catch (error) {
                showMessage(`新增失敗: ${error.message}`, 'error');
                console.error('新增文章失敗:', error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '確認新增';
            }
        });

        // 頁面初始化
        loadForums();
        loadForumTags().then(() => {
            // 在載入文章類別後，確保預設圖片選項的初始化狀態
            handleImageSourceChange();
        });
    });
</script>
</body>
</html>