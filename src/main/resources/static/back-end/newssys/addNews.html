<!-- new-article.html  (vFinal-plus：Summernote 顯示圖片、toolbar 含圖片上傳；符合 NewsCreationDTO) -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8"/>
    <title>新增新聞 | Pixel Tribe CMS</title>

    <!-- ===== 核心樣式 ===== -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/testvender/css/summernote-lite.min.css"/> <!-- ✦ 本機 Lite 版 CSS -->

    <style>
        :root {
            --primary: #0056b3;
            --accent: #1abc9c;
        }

        body {
            background: #f8fafc
        }

        h1 {
            color: var(--primary)
        }

        .card {
            border: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1)
        }

        .btn-primary {
            background: var(--primary);
            border: 0
        }

        .btn-primary:hover {
            background: #003d82
        }

        .note-editable {
            min-height: 300px
        }

        /* ✦ Summernote 編輯區高度 */
        .required::after {
            content: " *";
            color: #dc3545
        }
    </style>
</head>
<body>
<div class="container py-5">
    <h1 class="mb-4">新增新聞</h1>

    <div class="card p-4">
        <form id="newsForm">
            <!-- ===== 標題 ===== -->
            <div class="mb-3">
                <label class="form-label required">標題</label>
                <input class="form-control" id="title" name="newsTit" maxlength="255" required>
            </div>

            <!-- ===== 分類(tags) ===== -->
            <div class="mb-3">
                <label class="form-label required">分類 (可複選做為 tags)</label>
                <select class="form-select" id="categorySelect" name="tags" multiple size="4" required></select>
                <div class="form-text">※ 按 Ctrl / ⌘ 可複選，最少選 1 項</div>
            </div>

            <!-- ===== 內文 (Summernote) ===== -->
            <div class="mb-3">
                <label class="form-label required">內文</label>
                <textarea id="editor" name="newsCon"></textarea>
            </div>

            <!-- ===== 前台是否顯示 ===== -->
            <div class="form-check form-switch mb-4">
                <input class="form-check-input" type="checkbox" role="switch" id="isShow" checked>
                <label class="form-check-label" for="isShow">前台顯示</label>
            </div>

            <button type="submit" class="btn btn-primary">發佈</button>
        </form>
    </div>

    <!-- ===== 發佈成功 Toast ===== -->
    <div id="toast" class="toast position-fixed bottom-0 end-0 m-4 text-bg-success" role="alert" data-bs-delay="2500">
        <div class="d-flex">
            <div class="toast-body">已成功發佈！</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- ===== 依賴腳本 ===== -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>                 <!-- ✦ jQuery CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/testvender/js/summernote-lite.js"></script>                           <!-- ✦ 本機 Lite 版 JS -->
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>

<script>
    /* ========= 通用設定 ========= */
    const token = sessionStorage.getItem('accessToken');
    axios.defaults.headers.common['Authorization'] = token ? `Bearer ${token}` : '';

    /* 0. 預設 adminNo = 2，可由 JWT 覆蓋 */
    let adminNo = 2;
    try {
        if (token) {
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (payload.adminNo) adminNo = payload.adminNo;
        }
    } catch (e) {
        console.warn('無法解析 token adminNo，已使用預設 2');
    }

    /* 1. 動態載入分類 (tags) */
    axios.get('/api/admin/allNewsCategories')
        .then(res => {
            const sel = document.getElementById('categorySelect');
            res.data.forEach(c => sel.insertAdjacentHTML('beforeend',
                `<option value="${c.id}">${c.ncatName}</option>`));
        })
        .catch(err => {
            console.error(err);
            alert('載入分類失敗');
        });

    /* 2. 初始化 Summernote（含圖片上傳） */
    $('#editor').summernote({
        lang: 'zh-TW',
        height: 300,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'clear']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['insert', ['link', 'picture', 'table']],
            ['view', ['undo', 'redo', 'codeview']]
        ],
        callbacks: {
            onImageUpload: function (files) {
                Array.from(files).forEach(uploadImage)
            }
        }
    });

    /* 圖片上傳函式：呼叫後端並插入 URL */
    function uploadImage(file) {
        const formData = new FormData();
        formData.append('file', file);

        axios.post('/api/news/image/upload/temp', formData, {           // ★ 依實作改 newsId
            headers: {
                'Content-Type': 'multipart/form-data',
                ...(token && {Authorization: `Bearer ${token}`})
            }
        })
            .then(res => {
                $('#editor').summernote('insertImage', res.data.url);
            })
            .catch(err => {9/60
                console.error(err);
                alert('圖片上傳失敗');
            });
    }

    /* 3. 送出表單 */
    document.getElementById('newsForm').addEventListener('submit', async evt => {
        evt.preventDefault();

        const tagIds = Array.from(document.getElementById('categorySelect')
            .selectedOptions).map(o => +o.value);

        const payload = {
            adminNo: adminNo,
            newsTit: document.getElementById('title').value.trim(),
            newsCon: $('#editor').summernote('code'),
            tags: tagIds,
            isShowed: document.getElementById('isShow').checked ? 1 : 0
        };

        if (!payload.newsTit || !payload.newsCon || tagIds.length === 0) {
            alert('「標題／內文／至少一個分類」為必填');
            return;
        }

        try {
            await axios.post('/api/News/admin/create', payload, {
                headers: {'Content-Type': 'application/json'}
            });
            document.getElementById('newsForm').reset();
            $('#editor').summernote('reset');
            new bootstrap.Toast(document.getElementById('toast')).show();
        } catch (err) {
            console.error(err);
            alert('發佈失敗：' + (err.response?.data?.message || err));
        }
    });
</script>
</body>
</html>
