<!-- static/back-end/newssys/report/allNewsReport.html -->
<div class="report-management-container">
    <div class="page-title-header">
        <h2><i class="bi bi-flag-fill item-icon"></i>新聞留言檢舉列表</h2>
    </div>

    <div class="control-bar">
        <div class="filter-group">
            <label for="statusFilter">狀態：</label>
            <select id="statusFilter" class="filter-select" onchange="resetAndFetch()">
                <option value="">全部</option>
                <option value="0">待處理</option>
                <option value="1">已處理</option>
            </select>
        </div>
    </div>

    <div id="error-message" style="display:none; color:red; margin-bottom: 10px;"></div>

    <div class="table-container">
        <table class="table table-striped align-middle text-center">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>留言內容</th>
                <th>檢舉類型</th>
                <th>建立時間</th>
                <th>狀態</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
        </table>
    </div>

    <div class="pagination-controls mt-3 text-center">
        <button class="btn btn-secondary" onclick="prevPage()">上一頁</button>
        <span id="pageInfo" class="mx-2">第 1 頁</span>
        <button class="btn btn-secondary" onclick="nextPage()">下一頁</button>
    </div>
</div>

<script>
    (function () {
        /* -------- 共用 -------- */
        const pageSize = 5;
        let currentPage = 0;
        let totalPages  = 0;
        const jwtToken  = localStorage.getItem('jwt') || '';

        /* -------- 抓取並渲染 -------- */
        async function fetchPage() {
            const status  = document.getElementById('statusFilter').value;
            let url = `/api/admin/NewsComReport?page=${currentPage}&size=${pageSize}`;
            if (status) url += `&status=${status}`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + jwtToken }
                });
                if (!res.ok) throw new Error(`(${res.status}) 無法取得資料`);

                const pageData = await res.json();
                renderList(pageData.content || []);
                totalPages = pageData.totalPages || 0;
                document.getElementById('pageInfo').textContent =
                    `第 ${pageData.pageNumber + 1} 頁，共 ${totalPages} 頁`;
                document.getElementById('error-message').style.display = 'none';
            } catch (err) {
                const box = document.getElementById('error-message');
                box.textContent = err.message;
                box.style.display = 'block';
                renderList([]);                         // 清空表格
            }
        }

        function renderList(list) {
            const tb = document.getElementById('reportTableBody');
            if (!Array.isArray(list) || list.length === 0) {
                tb.innerHTML = `<tr><td colspan="6">查無資料</td></tr>`;
                return;
            }
            tb.innerHTML = list.map(r => `
      <tr>
        <td>${r.id}</td>
        <td class="text-start">${r.newsComment ?? '-'}</td>
        <td>${r.reportTypeRpiType ?? '-'}</td>
        <td>${formatDate(r.createTime)}</td>
        <td>${renderStatus(r.newsComReportStatus)}</td>
        <td>
          <a href="#"
             class="btn btn-outline-primary btn-sm"
             onclick="event.preventDefault();
                      loadExternalPage('../newssys/report/processNewsReport.html?id=${r.id}')">
             處理
          </a>
        </td>
      </tr>
    `).join('');
        }

        /* -------- 小工具 -------- */
        function renderStatus(code){
            if (code === '0') return `<span class="status-pill status-pending">待處理</span>`;
            if (code === '1') return `<span class="status-pill status-done">已處理</span>`;
            return '-';
        }
        const formatDate = s => s ? new Date(s).toLocaleString('zh-TW') : '-';

        /* -------- 揭露給外層（按鈕用） -------- */
        window.newsReport_prevPage = function () {
            if (currentPage > 0) { currentPage--; fetchPage(); }
        };
        window.newsReport_nextPage = function () {
            if (currentPage < totalPages - 1) { currentPage++; fetchPage(); }
        };
        window.newsReport_resetAndFetch = function () {
            currentPage = 0; fetchPage();
        };

        /* -------- 首次載入 -------- */
        fetchPage();
    })();                                         // IIFE end
</script>
