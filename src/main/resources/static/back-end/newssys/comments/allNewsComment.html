<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>新聞留言管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<!--    <style>-->
<!--        /* === 按鈕顏色 === */-->
<!--        .btn-edit   { background:#ffc107; border:none; }-->
<!--        .btn-edit:hover { background:#ffca2c; }-->

<!--        .btn-toggle { background:#6c757d; border:none; }-->
<!--        .btn-toggle:hover { background:#5c636a; }-->
<!--        .btn-toggle.show  { background:#198754; }-->
<!--        .btn-toggle.show:hover { background:#157347; }-->

<!--        /* === 狀態膠囊 === */-->
<!--        .status-pill   { display:inline-block; font-weight:600; font-size:.875rem;-->
<!--            padding:2px 12px; border-radius:999px; }-->
<!--        .status-normal { color:#198754; background:#e6f4ea; }-->
<!--        .status-hide   { color:#b02a37; background:#fdecea; }-->

<!--        /*body {*/-->
<!--        /*    max-width: 1400px;*/-->
<!--        /*    margin: 0 auto;*/-->
<!--        /*    padding: 24px;*/-->
<!--        /*    background: #f4f7f6;*/-->
<!--        /*    font-family: "Segoe UI", sans-serif*/-->
<!--        /*}*/-->

<!--        h1 {-->
<!--            color: #2c3e50-->
<!--        }-->

<!--        table {-->
<!--            margin-top: 1rem;-->

<!--        }-->

<!--        th, td {-->
<!--            text-align: center;-->
<!--            vertical-align: middle-->
<!--        }-->

<!--        tbody tr:nth-child(even) {-->
<!--            background: #f2f2f2-->
<!--        }-->

<!--        tbody tr:hover {-->
<!--            background: #e8f4fd-->
<!--        }-->

<!--        .pagination button {-->
<!--            margin: 0 .25rem-->
<!--        }-->

<!--        #errorMsg {-->
<!--            display: none-->
<!--        }-->
<!--    </style>-->

    <style>
        body {
            margin: 0 auto;
            padding: 24px;
            background: #f4f7f6;
            font-family: "Segoe UI", sans-serif;
        }

        .news-comments-container {
            max-width: 100%;
            padding: 24px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        /* 狀態膠囊 */
        .status-pill {
            display: inline-block;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 2px 12px;
            border-radius: 999px;
        }
        .status-normal {
            color: #198754;
            background: #e6f4ea;
        }
        .status-hide {
            color: #b02a37;
            background: #fdecea;
        }

        /* 按鈕樣式統一 */
        .btn-edit {
            background: #ffc107;
            border: none;
        }
        .btn-edit:hover {
            background: #ffca2c;
        }

        .btn-toggle {
            background: #6c757d;
            border: none;
        }
        .btn-toggle:hover {
            background: #5c636a;
        }
        .btn-toggle.show {
            background: #198754;
        }
        .btn-toggle.show:hover {
            background: #157347;
        }

        /* 表格風格 */
        table {
            width: 100%;
            margin-top: 1rem;
        }
        th, td {
            text-align: center;
            vertical-align: middle;
        }
        tbody tr:nth-child(even) {
            background: #f9f9f9;
        }
        tbody tr:hover {
            background: #f0f8ff;
        }
        .pagination button {
            margin: 0 .25rem;
        }
        #tblBody td:last-child {
            white-space: nowrap;
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: center;
        }
        #tblBody button {
            min-width: 50px;
        }
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        border-radius: 12px;
        background: #fff;


    </style>
</head>
<body>
<!-- 原本：<div class="news-comments-container"> -->
<div class="container-fluid px-4 news-comments-container">

    <h2 class="mb-3">新聞留言管理</h2>

    <!-- 篩選列 ----------------------------------------------------- -->
    <div class="row g-3 mb-3">
        <div class="col-md-2"><input id="keyword" class="form-control" placeholder="關鍵字"></div>
        <div class="col-md-2"><input id="newsId" class="form-control" placeholder="新聞 ID"></div>
        <div class="col-md-2"><input id="memberId" class="form-control" placeholder="會員 ID"></div>
        <div class="col-md-2">
            <select id="status" class="form-select">
                <option value="">全部狀態</option>
                <option value="1">正常</option>
                <option value="2">隱藏</option>
            </select>
        </div>
        <div class="col-md-2 d-grid">
            <button id="searchBtn" class="btn btn-primary">搜尋</button>
        </div>
    </div>

    <!-- 表格 ------------------------------------------------------- -->
    <div class="table-responsive">
<!--        table-bordered table-striped-->
        <table class="table  align-middle">
            <thead class="table-primary">
            <tr>
                <th>ID</th>
                <th style="width:32%">內容</th>
                <th>所屬新聞ID</th>
                <th>留言會員</th>
                <th>讚／倒讚</th>
                <th>狀態</th>
                <th>留言時間</th>
                <th>操作</th>
            </tr>
            </thead>

            <tbody id="tblBody">
            <tr>
                <td colspan="9" class="text-center text-muted">載入中…</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 分頁 ------------------------------------------------------- -->
    <nav>
        <ul id="pagination" class="pagination justify-content-center"></ul>
    </nav>

    <div id="errorMsg" class="alert alert-danger mt-3" style="display:none"></div>
</div>

<script>
    /* ====== 常量 (依實際部署調整) ====== */
    const API_BASE_URL = window.location.origin;
    const LIST_API = '/api/admin/NewsComment';
    const HIDE_API = id => `/api/admin/NewsComment/${id}/hide`;
    const EDIT_PAGE_PATH = '../newssys/comments/editNewsComment.html';
    const PAGE_SIZE = 10;

    /* ====== 事件 ====== */
    document.getElementById('searchBtn').addEventListener('click', () => loadPage(0));

    /* ====== 主流程 ====== */
    let currentPage = 0;
    loadPage(0);

    async function loadPage(page) {
        currentPage = page;
        showError();
        const params = new URLSearchParams({
            page, size: PAGE_SIZE,
            keyword: val('keyword'),
            newsId: val('newsId'),
            memberId: val('memberId'),
            status: val('status')
        }).toString();

        try {
            const res = await fetch(`${API_BASE_URL}${LIST_API}?${params}`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            renderTable(data.content);
            renderPagination(data.totalPages);
        } catch (e) {
            showError('載入失敗：' + e.message);
        }
    }

    function renderTable(list) {
        const tb = document.getElementById('tblBody');
        if (!list.length) {
            tb.innerHTML = '<tr><td colspan="8" class="text-center">無資料</td></tr>';
            return;
        }

        tb.innerHTML = list.map(r => `
    <tr>
      <!-- #1 留言 ID -->
      <td>${r.id}</td>

      <!-- #2 內容 -->
      <td class="text-start">${escapeHtml(r.ncomCon)}</td>

      <!-- #3 新聞 ID -->
      <td>${r.newsNoId}</td>

      <!-- #4 會員 (暱稱 + ID) -->
      <td>${r.memNoMemNickName || ''}<small class="text-muted">(ID: ${r.memNoId})</small></td>

      <!-- #5 讚 / 倒讚 -->
      <td>${r.ncomLikeLc} / ${r.ncomLikeDlc}</td>

      <!-- #6 狀態 -->
      <td>
        <span class="status-pill ${r.ncomStatus === '2' ? 'status-hide' : 'status-normal'}">
          ${r.ncomStatus === '2' ? '隱藏' : '正常'}
        </span>
      </td>

      <!-- #7 時間 -->
      <td>${new Date(r.ncomCre).toLocaleString()}</td>

      <!-- #8 操作 -->
      <td>
        <button class="btn btn-edit btn-sm text-white" onclick="openEdit(${r.id})">修改</button>
        <button class="btn btn-toggle btn-sm text-white ${r.ncomStatus === '2' ? 'show' : ''}"
                onclick="toggleHide(${r.id},${r.ncomStatus !== '2'})">
          ${r.ncomStatus === '2' ? '顯示' : '隱藏'}
        </button>
      </td>
    </tr>`).join('');
    }


    function renderPagination(total) {
        const ul = document.getElementById('pagination');
        ul.innerHTML = '';
        for (let i = 0; i < total; i++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (i === currentPage ? ' active' : '');
            li.innerHTML = `<button class="page-link">${i + 1}</button>`;
            li.onclick = () => loadPage(i);
            ul.appendChild(li);
        }
    }

    async function toggleHide(id, hidden) {
        if (!confirm(`確定要${hidden ? '隱藏' : '顯示'}留言 ${id}？`)) return;
        try {
            const res = await fetch(API_BASE_URL + HIDE_API(id), {
                method: 'PATCH', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({hidden})
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            loadPage(currentPage);
        } catch (e) {
            alert('操作失敗：' + e.message);
        }
    }

    function openEdit(id) {
        if (typeof loadExternalPage === 'function') {
            loadExternalPage(`${EDIT_PAGE_PATH}?id=${id}`);
        } else {
            window.location.href = `${EDIT_PAGE_PATH}?id=${id}`;
        }
    }

    /* ====== 工具 ====== */
    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));
    }

    function val(id) {
        return document.getElementById(id).value.trim();
    }

    function showError(msg = '') {
        const e = document.getElementById('errorMsg');
        e.textContent = msg;
        e.style.display = msg ? 'block' : 'none';
    }
</script>
</body>