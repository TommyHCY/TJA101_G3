<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>新聞管理後台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/vendors/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/vendors/bootstrap-icons/bootstrap-icons.css">
    <style>
        body {
            padding-top: 0 !important;
            padding-bottom: 2rem;
            background-color: #f8f9fa; /* 可加可不加 */
        }

        .news-container {
            max-width: 1280px;
            margin: 1rem auto 0 auto;
        }

        th.sortable:hover {
            cursor: pointer;
            text-decoration: underline;
        }

        table th, table td {
            white-space: nowrap;
            vertical-align: middle;
        }

        th[data-field="id"],
        td:nth-child(1) {
            min-width: 50px;
            text-align: center;
        }

        th[data-field="newsTit"],
        td:nth-child(2) {
            min-width: 300px;
            max-width: 400px;
            word-break: break-word;
        }

        td:nth-child(3) {
            min-width: 60px;
            text-align: center;
        }

        td:nth-child(4),
        td:nth-child(5) {
            min-width: 160px;
        }

        td:nth-child(6) {
            min-width: 100px;
            text-align: center;
        }

        td:nth-child(7) {
            min-width: 140px;
            text-align: center;
        }
    </style>
</head>

<body class="pt-2 px-3 pb-4">
<div class="container-xl news-container">
    <h2><i class="bi bi-card-list item-icon"></i> 新聞管理</h2>

    <!-- 控制列 -->
    <div class="row mb-3 align-items-center">
        <div class="col-auto">
            <label class="form-label mb-0">每頁顯示：</label>
        </div>
        <div class="col-auto">
            <select id="pageSizeSelect" class="form-select form-select-sm">
                <option>3</option>
                <option selected>5</option>
                <option>10</option>
            </select>
        </div>

        <div class="col-auto ms-4">
            <label class="form-label mb-0">搜尋：</label>
        </div>
        <div class="col-auto">
            <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="標題關鍵字"/>
        </div>

        <div class="col text-end">
            <button class="btn btn-success btn-sm" id="addNewsBtn">
                <i class="bi bi-plus-lg"></i> 新增新聞
            </button>
        </div>
    </div>

    <!-- 錯誤訊息 -->
    <div class="alert alert-danger d-none" id="errorAlert">載入失敗，請檢查後端或 CORS 設定</div>

    <!-- 表格 -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-success">
            <tr>
                <th class="sortable" data-field="id">ID</th>
                <th class="sortable" data-field="newsTit">標題</th>
                <th>狀態</th>
                <th class="sortable" data-field="newsCrdate">建立時間</th>
                <th class="sortable" data-field="newsUpdate">修改時間</th>
                <th>發布人</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="newsTableBody"></tbody>
        </table>
    </div>

    <!-- 分頁 -->
    <nav class="d-flex justify-content-center mt-3">
        <ul class="pagination" id="paginationNav"></ul>
    </nav>
</div>

<!-- JS -->
<script src="/assets/vendors/jquery/jquery.min.js"></script>
<script>
    (function () {
        let currentPage = 0;
        let currentSize = 5;
        let currentKeyword = "";
        let currentSortField = "id";
        let currentSortDirection = "desc";

        function loadNews() {
            const token = localStorage.getItem('jwt');
            const url = `http://localhost:8080/api/News/admin/allNews?page=${currentPage}&size=${currentSize}&sort=${currentSortField},${currentSortDirection}&keyword=${encodeURIComponent(currentKeyword)}`;

            $.ajax({
                url,
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (res) {
                    renderTable(res.content);
                    renderPagination(res.totalPages, res.number);
                },
                error: function (err) {
                    $('#errorAlert').removeClass('d-none');
                    console.error("載入失敗", err);
                }
            });
        }

        function renderTable(newsList) {
            const $tbody = $("#newsTableBody").empty();
            if (!newsList || newsList.length === 0) {
                $tbody.append(`<tr><td colspan="7" class="text-center">目前沒有任何新聞資料。</td></tr>`);
                return;
            }

            newsList.forEach(news => {
                const createTime = news.newsCrdate ? new Date(news.newsCrdate).toLocaleString() : "未提供";
                const updateTime = news.newsUpdate ? new Date(news.newsUpdate).toLocaleString() : "未修改";

                const row = `
        <tr>
          <td>${news.id}</td>
          <td>${news.newsTit}</td>
          <td>${news.isShowed ? '顯示' : '隱藏'}</td>
          <td>${createTime}</td>
          <td>${updateTime}</td>
          <td>${news.adminNoAdmName || '未指定'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${news.id}">編輯</button>
            <button class="btn btn-sm btn-outline-warning toggle-btn" data-id="${news.id}" data-showed="${news.isShowed}">
              ${news.isShowed ? '隱藏' : '顯示'}
            </button>
          </td>
        </tr>`;
                $tbody.append(row);
            });

            $(".toggle-btn").click(function () {
                const id = $(this).data("id");
                const currentStatus = $(this).data("showed");
                const newStatus = !currentStatus;
                const token = localStorage.getItem('jwt');

                $.ajax({
                    url: `http://localhost:8080/api/News/admin/updateShowStatus/${id}`,
                    method: "PUT",
                    headers: { "Authorization": "Bearer " + token },
                    contentType: "application/json",
                    data: JSON.stringify({ isShowed: newStatus }),
                    success: () => loadNews(),
                    error: () => alert("切換狀態失敗！")
                });
            });
        }

        function renderPagination(totalPages, currentPageIndex) {
            const $nav = $("#paginationNav").empty();
            for (let i = 0; i < totalPages; i++) {
                const isActive = i === currentPageIndex ? 'active' : '';
                $nav.append(`<li class="page-item ${isActive}"><a class="page-link" href="#">${i + 1}</a></li>`);
            }

            $(".page-link").click(function (e) {
                e.preventDefault();
                currentPage = parseInt($(this).text()) - 1;
                loadNews();
            });
        }

        $(function () {
            loadNews();

            $("#pageSizeSelect").change(function () {
                currentSize = parseInt($(this).val());
                currentPage = 0;
                loadNews();
            });

            $("#searchInput").on("input", function () {
                currentKeyword = $(this).val();
                currentPage = 0;
                loadNews();
            });

            $("th.sortable").click(function () {
                const field = $(this).data("field");
                if (currentSortField === field) {
                    currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
                } else {
                    currentSortField = field;
                    currentSortDirection = "asc";
                }
                loadNews();
            });

            $("#addNewsBtn").click(() => {
                window.location.href = "/back-end/newssys/addNews.html";
            });
        });
    })();
</script>
</body>
</html>
