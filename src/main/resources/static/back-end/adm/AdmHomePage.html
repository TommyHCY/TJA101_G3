<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>PixelTribe 管理員首頁</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Karla:wght@400;700&family=Press+Start+2P&display=swap"
	rel="stylesheet">

<link rel="stylesheet"
	href="../../../assets/vendors/bootstrap-icons/bootstrap-icons.css">
<link rel="stylesheet"
	href="/assets/vendors/bootstrap/bootstrap.min.css">
<style>
body {
	width: 100vw;
	height: 100vh;
	/* 【核心修改】將 overflow-x: hidden 改為 overflow: hidden; */
	/* 理由：徹底禁止 body 元素產生任何方向的滾動條，將滾動控制權完全交給內部的 content-card。 */
	overflow: hidden;
}

/* --- 核心變數: 全面替換為前台薄荷綠風格 --- */
:root {
	--primary-bg: #f0f2f5;
	--component-bg: #ffffff;
	--border-color: #e0e0e0;
	--text-color: #5d5d66;
	--text-muted: #6c757d;
	--brand-green: #08beab;
	--brand-green-hover: #07a897;
	--brand-green-light: rgba(8, 190, 171, 0.1);
}

/* --- 基礎樣式: 統一字體與背景 --- */
html, body {
	margin: 0;
	padding: 0;
	height: 100%;
	min-height: 100vh;
	background: var(--primary-bg);
	font-family: 'Karla', '微軟正黑體', Arial, sans-serif;
	box-sizing: border-box;
	color: var(--text-color);
}

body {
	width: 100vw;
	height: 100vh;
	overflow-x: hidden;
}

/* --- 頂部導覽列 --- */
.topbar {
	width: 100%;
	height: 60px;
	background: var(--component-bg);
	display: flex;
	align-items: center;
	justify-content: space-between;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
	position: fixed;
	top: 0;
	left: 0;
	z-index: 10;
	padding: 0 24px;
	box-sizing: border-box;
	border-bottom: 1px solid var(--border-color);
}

.topbar-logo img {
	height: 40px;
	width: auto;
	vertical-align: middle;
}

.logout-btn {
	background: var(--brand-green-light);
	color: var(--brand-green);
	border: 2px solid var(--brand-green);
	border-radius: 8px;
	padding: 8px 24px;
	font-family: 'Karla', sans-serif;
	font-size: 14px;
	font-weight: 700;
	cursor: pointer;
	transition: all 0.2s ease;
}

.logout-btn:hover {
	background: var(--brand-green);
	color: var(--component-bg);
}

/* --- 主要佈局 --- */
.main-wrap {
	display: flex;
	height: calc(100vh - 60px);
	min-height: 540px;
	margin-top: 60px;
}

/* --- 左側選單欄 --- */
.sidebar-card {
	width: 280px;
	background: var(--component-bg);
	border-radius: 0;
	padding: 24px 0;
	display: flex;
	flex-direction: column;
	align-items: center;
	height: 100%;
	border-right: 1px solid var(--border-color);
}

.sidebar-menu {
	width: 100%;
	list-style: none;
	padding: 0 12px;
	margin: 0;
}

.menu-item {
	width: 100%;
	margin-bottom: 8px;
}

.menu-button {
	display: flex;
	align-items: center;
	justify-content: space-between;
	width: 100%;
	margin: 0 auto;
	padding: 14px 20px;
	font-size: 16px;
	color: var(--text-color);
	background: none;
	border: none;
	border-radius: 8px;
	font-family: inherit;
	cursor: pointer;
	transition: background 0.15s, color 0.15s;
	outline: none;
	font-weight: 700;
	letter-spacing: 0.2px;
}

.menu-button:hover {
	background: var(--brand-green-light);
	color: var(--brand-green);
}

.menu-button.active {
	background: var(--brand-green);
	color: var(--component-bg);
}

.menu-button .icon {
	margin-right: 16px;
	font-size: 18px;
	vertical-align: -0.15em;
}

.menu-button .arrow {
	font-size: 14px;
	transition: transform 0.3s ease;
}

.menu-item.active .menu-button .arrow {
	transform: rotate(180deg);
}

.submenu {
	width: 93%;
	margin: 4px auto 0;
	background: var(--primary-bg);
	border-radius: 8px;
	max-height: 0;
	overflow: hidden;
	transition: max-height 0.4s ease-out, opacity 0.4s ease-out;
	opacity: 0;
}

.menu-item.active .submenu {
	max-height: 550px;
	opacity: 1;
}

.submenu-item {
	padding: 10px 18px 10px 48px;
	transition: all 0.13s ease;
	cursor: pointer;
	position: relative;
	font-size: 15px;
	color: var(--text-muted);
	font-weight: 500;
	display: block;
	text-decoration: none;
	border-bottom: 1px solid var(--border-color);
}

.submenu-item:last-child {
	border-bottom: none;
}

.submenu-item:hover {
	background: var(--brand-green-light);
	color: var(--brand-green);
}

.submenu-item.active {
	background: var(--brand-green-light);
	color: var(--brand-green);
	font-weight: 700;
}

.submenu-item .item-icon {
	position: absolute;
	left: 20px;
	top: 50%;
	transform: translateY(-50%);
	font-size: 16px;
	color: var(--brand-green);
}

/* --- 右側內容區 --- */
/* --- 右側內容區 --- */
.content-card {
	flex: 1;
	/* 【核心修改】讓內容區本身變成白色卡片 */
	background: var(--component-bg); /* 改成白色 */
	border-radius: 12px; /* 給它一個圓角，更好看 */
	margin: 24px; /* 用 margin 代替 padding，讓灰色背景露出來 */
	padding: 24px; /* padding 用來約束內部元素，而不是製造外部間距 */
	/* 以下不變 */
	min-width: 0;
	min-height: calc(100% - 48px); /* 減去上下 margin */
	display: flex;
	/* 【核心修改】不再需要 justify-content，因為內容要填滿 */
	/* justify-content: center; */
	overflow-y: auto;
	box-sizing: border-box; /* 確保 padding 和 border 不會撐大盒子 */
}

.content-card {
	border-radius: 0;
	box-shadow: none;
}

.dashboard-content {
	width: 100%;
	max-width: 1100px;
	margin: 0 auto;
}

.welcome-section {
	width: 100%;
	margin-bottom: 40px;
	text-align: left;
}

.welcome-title {
	font-family: 'Karla', sans-serif;
	font-size: 28px;
	color: var(--text-color);
	font-weight: 700;
	margin-bottom: 10px;
	padding: 0;
	background: none;
	border-left: none;
	box-shadow: none;
}

.welcome-subtitle {
	font-size: 16px;
	color: var(--text-muted);
	margin: 0;
	max-width: none;
	text-align: left;
}

.stats-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
	gap: 25px;
	width: 100%;
	margin-bottom: 40px;
}

.stat-card {
	background: var(--component-bg);
	border-radius: 12px;
	padding: 25px;
	text-align: center;
	transition: all 0.2s ease;
	border: 1px solid var(--border-color);
	min-height: 160px;
	display: flex;
	flex-direction: column;
	justify-content: center;
	align-items: center;
}

.stat-card:hover {
	transform: translateY(-5px);
	box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
}

.stat-icon {
	font-size: 40px;
	margin-bottom: 15px;
	color: var(--brand-green);
}

.stat-number {
	font-size: 36px;
	font-weight: 700;
	color: var(--text-color);
	margin-bottom: 8px;
}

.stat-label {
	font-size: 15px;
	font-weight: 500;
	color: var(--text-muted);
}

.guide-text {
	width: 100%;
	background: var(--component-bg);
	border: 1px solid var(--border-color);
	border-radius: 12px;
	padding: 30px;
	margin-top: 20px;
}

.guide-text h3 {
	font-family: 'Karla', sans-serif;
	color: var(--text-color);
	font-weight: 700;
	margin-bottom: 15px;
	font-size: 18px;
	letter-spacing: 0;
}

.guide-text p {
	font-size: 15px;
	line-height: 1.7;
	margin: 0;
	color: var(--text-muted);
}

.sys-block {
	width: 100%;
}

.sys-subtitle {
	font-family: 'Karla', sans-serif;
	font-size: 24px;
	color: var(--text-color);
	font-weight: 700;
	margin-bottom: 30px;
	letter-spacing: 0;
	padding: 0;
	background: none;
	border-left: none;
	box-shadow: none;
	display: block;
}

.sys-block ul {
	padding: 0;
	margin: 0;
	list-style: none;
	width: 100%;
}

.sys-block li {
	margin-bottom: 14px;
	font-size: 16px;
	padding: 15px 20px 15px 50px;
	border-radius: 8px;
	background: var(--component-bg);
	font-weight: 500;
	border: 1px solid var(--border-color);
	display: flex;
	align-items: center;
	position: relative;
	transition: all 0.2s ease;
}

.sys-block li:hover {
	border-color: var(--brand-green);
	background: var(--brand-green-light);
}

.sys-block li .item-icon {
	position: absolute;
	left: 20px;
	font-size: 18px;
	color: var(--brand-green);
}

/* --- 響應式設計 --- */
@media ( max-width : 1100px) {
	.main-wrap {
		flex-direction: column;
	}
	.sidebar-card, .content-card {
		border-radius: 0;
		width: 100%;
		border-right: none;
	}
	.content-card {
		padding: 30px 4vw;
		border-top: 1px solid var(--border-color);
	}
	.sidebar-card {
		padding: 12px 0;
		height: auto;
	}
}

@media ( max-width : 650px) {
	.content-card {
		padding: 20px;
	}
	.topbar-logo img {
		height: 35px;
	}
	.logout-btn {
		padding: 6px 16px;
		font-size: 13px;
	}
	.stats-grid {
		grid-template-columns: 1fr;
		gap: 15px;
	}
}
</style>
</head>
<body>

	<div class="topbar">
		<a href="#" class="topbar-logo" onclick="loadMainDashboard(event)">
			<img src="../../../images/logo.png" alt="Pixel Tribe Logo">
		</a>
		<button class="logout-btn" onclick="handleLogout()">登出</button>
	</div>
	<div class="main-wrap">
		<nav class="sidebar-card">
			<ul class="sidebar-menu">
				<li class="menu-item" id="menu-store">
					<button class="menu-button" onclick="toggleMenu('store')">
						<span><i class="bi bi-shop-window icon"></i>商城系統</span> <i
							class="bi bi-chevron-down arrow"></i>
					</button>
					<div class="submenu">
						<a href="#" class="submenu-item"
							onclick="renderContent('store', 'dashboard', event)"> <i
							class="bi bi-pie-chart-fill item-icon"></i>儀表板
						</a> 
						<a href="#" class="submenu-item"
							onclick="renderContent('store', 'management', event)"> <i
							class="bi bi-box-seam item-icon"></i>產品管理
						</a> 
						<a href="#" class="submenu-item"
							onclick="renderContent('store', 'malltag', event)"> <i
							class="bi bi-tags-fill item-icon"></i>產品分類
						</a> 
						<a href="#" class="submenu-item"
							onclick="renderContent('store', 'orders', event)"> <i
							class="bi bi-receipt-cutoff item-icon"></i>訂單管理
						</a>  
						<a href="#" class="submenu-item"
							onclick="renderContent('store', 'comment', event)"> <i
							class="bi bi-chat-square-text-fill item-icon"></i>訂單評論管理
						</a> 
					</div>
				</li>
				<li class="menu-item" id="menu-news">
					<button class="menu-button" onclick="toggleMenu('news')">
						<span><i class="bi bi-newspaper icon"></i>新聞系統</span> <i
							class="bi bi-chevron-down arrow"></i>
					</button>
					<div class="submenu">
						<a href="#" class="submenu-item"
							onclick="renderContent('news', 'dashboard', event)"> <i
							class="bi bi-pie-chart-fill item-icon"></i>儀表板
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('news', 'categories', event)"> <i
							class="bi bi-pencil-fill item-icon"></i>新聞類別管理
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('news', 'management', event)"> <i
							class="bi bi-pencil-fill item-icon"></i>新聞管理
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('news', 'comments', event)"> <i
							class="bi bi-chat-dots-fill item-icon"></i>新聞評論管理
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('news', 'reports', event)"> <i
							class="bi bi-shield-check item-icon"></i>新聞評論審核檢舉
						</a>
					</div>
				</li>
				<li class="menu-item" id="menu-forum">
					<button class="menu-button" onclick="toggleMenu('forum')">
						<span><i class="bi bi-chat-square-dots-fill icon"></i>討論區系統</span>
						<i class="bi bi-chevron-down arrow"></i>
					</button>
					<div class="submenu">
						<a href="#" class="submenu-item"
							onclick="renderContent('forum', 'dashboard', event)"> <i
							class="bi bi-pie-chart-fill item-icon"></i>儀表板
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('forum', 'categories', event)"> <i
							class="bi bi-tags-fill item-icon"></i>討論區類別管理
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('forum', 'forums', event)"> <i
							class="bi bi-card-list item-icon"></i>討論區管理
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('forum', 'posts', event)"> <i
							class="bi bi-file-text-fill item-icon"></i>文章管理
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('forum', 'comments', event)"> <i
							class="bi bi-chat-left-text-fill item-icon"></i>留言管理
						</a>
<!--						<a href="#" class="submenu-item"-->
<!--							onclick="renderContent('forum', 'official', event)"> <i-->
<!--							class="bi bi-megaphone-fill item-icon"></i>發布官方文章-->
<!--						</a> -->
						<a href="#" class="submenu-item"
							onclick="renderContent('forum', 'reports', event)"> <i
							class="bi bi-shield-check item-icon"></i>文章留言檢舉審核
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('forum', 'article-reports', event)"> <i
							class="bi bi-shield-check item-icon"></i>文章檢舉審核
						</a>
					</div>
				</li>
				<li class="menu-item" id="menu-member">
					<button class="menu-button" onclick="toggleMenu('member')">
						<span><i class="bi bi-people-fill icon"></i>會員系統</span> <i
							class="bi bi-chevron-down arrow"></i>
					</button>
					<div class="submenu">
						<a href="#" class="submenu-item"
							onclick="renderContent('member', 'dashboard', event)"> <i
							class="bi bi-pie-chart-fill item-icon"></i>儀表板
						</a> <a href="#" class="submenu-item"
							onclick="renderContent('member', 'query', event)"> <i
							class="bi bi-person-lines-fill item-icon"></i>會員管理
						</a>
					</div>
				</li>
			</ul>
		</nav>
		<main class="content-card" id="content-area"></main>
	</div>


	<script>
    // 【常數】將內容區域的 DOM 物件提出來，避免重複選取
    const contentArea = document.getElementById('content-area');

    // =================================================================================
    // 【核心修改】頁面路由設定：未來新增頁面，只需在此處增加一行對應
    // 格式：'主選單Key-子選單Key': '對應的 HTML 檔案路徑'
    // =================================================================================
    const pageMappings = {
        'store-management': '../shopsys/product/listAllProduct.html',
        'store-malltag': '../shopsys/malltag/listAllMallTag.html',
        'store-orders': '../shopsys/order/allOrder.html',
        'store-comment': '../shopsys/order/allComment.html',
        'forum-forums': '../forumsys/forum/allForum.html',
        'forum-add': '../forumsys/forum/addForum.html',
        'forum': '../forumsys/forum/forum.html',
        'forum-categories': '../forumsys/category/allCategory.html',
        'forum-add-category': '../forumsys/category/addCategory.html',
        'forum-edit-category': '../forumsys/category/editCategory.html',
        'forum-comments': '../forumsys/message/allMessages.html',
        'forum-reports': '../forumsys/messagereport/allReports.html',

        'forum-article-reports': '../forumsys/articlereport/allArticleReports.html', // [新增] 文章檢舉列表頁面
        'member-query': '../memsys/ListAllMem.html',
        'news-management': '../newssys/news/listAllNews.html',

        'news-categories': '../newssys/category/allNewsCategory.html',
        'news-add-category': '../newssys/category/addNewsCategory.html',
        'news-edit-category': '../newssys/category/editNewsCategory.html',
        'news-comments': '../newssys/comments/allNewsComment.html',
        'news-edit-comments': '../newssys/comments/editNewsComment.html',

        'news-reports': '../newssys/report/allNewsReport.html',
        'news-process-report': '../newssys/report/processNewsReport.html',

        'forum-posts': '../forumsys/forumpost/allForumPost.html', // [新增] 文章列表頁面
        'forum-add-post': '../forumsys/forumpost/addForumPost.html', // [新增] 新增文章頁面
        'forum-edit-post': '../forumsys/forumpost/forumPost.html', // [新增] 編輯文章頁面


        // 在此處繼續添加其他頁面...
    };


    function toggleMenu(menuKey) {
        const menuItem = document.getElementById('menu-' + menuKey);
        if (!menuItem) return;

        if (!menuItem.classList.contains('active')) {
            document.querySelectorAll('.menu-item.active').forEach(item => {
                item.classList.remove('active');
            });
        }
        menuItem.classList.toggle('active');
    }

    /**
     * 【核心修改】根據 key 決定渲染內部 HTML 還是載入外部頁面
     * @param {string} pageKey - 主選單 key (例如 'store')
     * @param {string} subKey - 子選單 key (例如 'orders')
     * @param {Event} event - 點擊事件物件
     */
    function renderContent(pageKey, subKey, event) {
        event.preventDefault();

        document.querySelectorAll('.submenu-item.active').forEach(item => item.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // [不可變] 組合 key，用於查詢 pageMappings
        const mappingKey = `${pageKey}-${subKey}`;
        const targetPath = pageMappings[mappingKey];

        // 如果在 pageMappings 中找到對應路徑，則載入外部檔案
        if (targetPath) {
            loadExternalPage(targetPath);
        } else if (pageKey === 'store' && subKey === 'dashboard') {
            // 對於原本內建的儀表板，保留原邏輯
            contentArea.innerHTML = getShopDashboardHTML();
            
         // 新增：載入商城統計數據
            setTimeout(async () => {
                const token = localStorage.getItem('jwt');
                if (!token) {
                    console.error('未找到 JWT Token');
                    return;
                }
                
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                
                try {
                    // 載入商品總數
                    const productResponse = await fetch('/api/admin/products/count', { headers });
                    if (productResponse.ok) {
                        const productCount = await productResponse.text();
                        document.getElementById('productCount').textContent = productCount || '0';
                    } else {
                        document.getElementById('productCount').textContent = '156'; // 預設值
                    }
                    
                    // 載入待處理訂單數
                    const orderResponse = await fetch('/api/admin/orders/pending/count', { headers });
                    if (orderResponse.ok) {
                        const orderCount = await orderResponse.text();
                        document.getElementById('pendingOrderCount').textContent = orderCount || '0';
                    } else {
                        document.getElementById('pendingOrderCount').textContent = '89'; // 預設值
                    }
                    
                    // 載入評論總數
                    const commentResponse = await fetch('/api/admin/comments/count', { headers });
                    if (commentResponse.ok) {
                        const commentCount = await commentResponse.text();
                        document.getElementById('commentCount').textContent = commentCount || '0';
                    } else {
                        document.getElementById('commentCount').textContent = '23'; // 預設值
                    }
                    
                    // 載入本月營收
                    const revenueResponse = await fetch('/api/admin/orders/monthly-revenue', { headers });
                    if (revenueResponse.ok) {
                        const revenue = await revenueResponse.json();
                        document.getElementById('monthlyRevenue').textContent = `$${revenue.toLocaleString('zh-TW')}` || '$0';
                    } else {
                        document.getElementById('monthlyRevenue').textContent = '$52,680'; // 預設值
                    }
                    
                } catch (error) {
                    console.error('載入商城儀表板統計失敗:', error);
                    // 發生錯誤時顯示預設值
                    document.getElementById('productCount').textContent = '156';
                    document.getElementById('pendingOrderCount').textContent = '89';
                    document.getElementById('commentCount').textContent = '23';
                    document.getElementById('monthlyRevenue').textContent = '$52,680';
                }
            }, 0);

        } else if (pageKey === 'news' && subKey === 'dashboard') {
            contentArea.innerHTML = getNewsDashboardHTML();
            setTimeout(async () => {
                const token = localStorage.getItem('jwt');
                const headers = {Authorization: 'Bearer ' + token};

                const newsCountEl = document.getElementById('newsCount');
                const commentCountEl = document.getElementById('commentCount');
                const pendingReportEl = document.getElementById('pendingReportCount');

                try {
                    const res1 = await fetch('/api/News/admin/newscount', {headers});
                    if (!res1.ok) throw new Error(`(${res1.status}) 新聞載入失敗`);
                    const newsCount = await res1.text();
                    if (newsCountEl) newsCountEl.innerText = newsCount;

                    const res2 = await fetch('/api/admin/NewsComment/count', {headers});
                    if (!res2.ok) throw new Error(`(${res2.status}) 評論載入失敗`);
                    const commentCount = await res2.text();
                    if (commentCountEl) commentCountEl.innerText = commentCount;

                    const res3 = await fetch('/api/admin/NewsComReport?status=0', {headers});
                    if (!res3.ok) throw new Error(`(${res3.status}) 檢舉載入失敗`);
                    const reportData = await res3.json();
                    if (pendingReportEl) pendingReportEl.innerText = reportData.content.length;
                } catch (err) {
                    console.error('儀表板數據載入失敗:', err);
                    if (newsCountEl) newsCountEl.innerText = '錯誤';
                    if (commentCountEl) commentCountEl.innerText = '錯誤';
                    if (pendingReportEl) pendingReportEl.innerText = '錯誤';
                }
            }, 0);
            // 【修改】新增 forum dashboard 的處理邏輯
        } else if (pageKey === 'forum' && subKey === 'dashboard') {
            contentArea.innerHTML = getForumDashboardHTML(); // 先渲染靜態 HTML
            // 立即執行非同步資料獲取
            setTimeout(async () => {
                const token = localStorage.getItem('jwt');
                if (!token) {
                    console.error("未找到 JWT");
                    return;
                }
                const headers = {Authorization: 'Bearer ' + token};

                // 獲取所有數字顯示的 DOM 元素
                const forumCountEl = document.getElementById('forumCount');
                const postCountEl = document.getElementById('postCount');
                const messageCountEl = document.getElementById('messageCount');
                const pendingArticleReportEl = document.getElementById('pendingArticleReportCount');
                const pendingCommentReportEl = document.getElementById('pendingCommentReportCount');

                try {
                    // ① 討論區總數
                    const res1 = await fetch('/api/admin/forumcount', {headers});
                    if (!res1.ok) throw new Error(`討論區數量載入失敗 (${res1.status})`);
                    const forumCount = await res1.text();
                    if (forumCountEl) forumCountEl.innerText = forumCount;

                    // ② 文章總數
                    const res2 = await fetch('/api/admin/forumpost/count', {headers});
                    if (!res2.ok) throw new Error(`文章數量載入失敗 (${res2.status})`);
                    const postCount = await res2.text();
                    if (postCountEl) postCountEl.innerText = postCount;

                    // ③ 留言總數
                    const res3 = await fetch('/api/admin/posts/messagecount', {headers});
                    if (!res3.ok) throw new Error(`留言數量載入失敗 (${res3.status})`);
                    const messageCount = await res3.text();
                    if (messageCountEl) messageCountEl.innerText = messageCount;

                    // ④ 待處理文章檢舉數
                    const res4 = await fetch('/api/admin/articlereports/pendingcoung', {headers});
                    if (!res4.ok) throw new Error(`文章檢舉數量載入失敗 (${res4.status})`);
                    const pendingArticleReportCount = await res4.text();
                    if (pendingArticleReportEl) pendingArticleReportEl.innerText = pendingArticleReportCount;

                    // ⑤ 待處理留言檢舉數
                    const res5 = await fetch('/api/admin/articlecomreports/pendingcount', {headers});
                    if (!res5.ok) throw new Error(`留言檢舉數量載入失敗 (${res5.status})`);
                    const pendingCommentReportCount = await res5.text();
                    if (pendingCommentReportEl) pendingCommentReportEl.innerText = pendingCommentReportCount;

                } catch (err) {
                    console.error('討論區儀表板數據載入失敗:', err);
                    if (forumCountEl) forumCountEl.innerText = '錯誤';
                    if (postCountEl) postCountEl.innerText = '錯誤';
                    if (messageCountEl) messageCountEl.innerText = '錯誤';
                    if (pendingArticleReportEl) pendingArticleReportEl.innerText = '錯誤';
                    if (pendingCommentReportEl) pendingCommentReportEl.innerText = '錯誤';
                }
            }, 0);
        } else if (pageKey === 'member' && subKey === 'dashboard'){
        	 contentArea.innerHTML = getMemberDashboardHTML();
        	    setTimeout(async () => {
        	        const token = localStorage.getItem('jwt');
        	        const headers = { Authorization: 'Bearer ' + token };

        	        const memberTotalCountEl = document.getElementById('memberTotalCount');
        	        const memberSuspendedCountEl = document.getElementById('memberSuspendedCount');
        	        const memberWeeklyNewCountEl = document.getElementById('memberWeeklyNewCount');

        	        try {
        	        	 const res1 = await fetch('/api/members/admin/count', { headers });
        	             if (!res1.ok) throw new Error('會員總數 API 錯誤');
        	             memberTotalCountEl.innerText = await res1.text();
        	         } catch (err) {
        	             memberTotalCountEl.innerText = '錯誤';
        	             console.error(err);
        	         }

        	         // 停權會員
        	         try {
        	             const res2 = await fetch('/api/members/admin/suspended-count', { headers });
        	             if (!res2.ok) throw new Error('停權會員 API 錯誤');
        	             memberSuspendedCountEl.innerText = await res2.text();
        	         } catch (err) {
        	             memberSuspendedCountEl.innerText = '錯誤';
        	             console.error(err);
        	         }

        	         // 本周新註冊
//         	         try {
//         	             const res3 = await fetch('/api/members/admin/newlySign', { headers });
//         	             if (!res3.ok) throw new Error('本周新註冊 API 錯誤');
//         	             memberMonthlyNewCountEl.innerText = await res3.text();
//         	         } catch (err) {
//         	             memberMonthlyNewCountEl.innerText = '錯誤';
//         	             console.error(err);
//         	         }
        	     }, 0);
        } else{
            // 其他所有未設定的頁面，顯示佔位內容
            contentArea.innerHTML = getPlaceholderHTML(pageKey, subKey);
        }
     }
    /**
     * 【核心修正】通用外部頁面載入器 (整合版)
     * @param {string} url - 要載入的 HTML 檔案路徑 (可包含查詢參數)
     */
    async function loadExternalPage(url) {
        try {
            contentArea.innerHTML = `<div class="sys-block" style="text-align: center; font-size: 20px;">載入中...</div>`;

            // [不可變] 這是修正的核心：建立一個完整的 URL 物件來解析傳入的相對路徑與參數。
            // window.location.href 作為第二個參數，可以確保相對路徑 (如 ../...) 被正確解析。
            const fullUrl = new URL(url, window.location.href);

            // [不可變] 將解析出的查詢字串 (例如 "?id=1") 存到 content-area 的 data-page-params 屬性中。
            // 這是為了讓子頁面的腳本可以讀取到這個值。
            contentArea.setAttribute('data-page-params', fullUrl.search);

            const response = await fetch(fullUrl);
            if (!response.ok) {
                throw new Error(`無法載入頁面: ${response.status} ${response.statusText}`);
            }
            const pageText = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(pageText, 'text/html');

            const styles = doc.querySelectorAll('style');
            const scripts = doc.querySelectorAll('script');
            const pageContent = doc.querySelector('[class*="-container"], [class*="-wrapper"]');

            if (!pageContent) {
                throw new Error("在載入的頁面中找不到主要的內容容器。");
            }

            contentArea.innerHTML = ''; // 清空
            contentArea.appendChild(pageContent);

            // 清理舊的動態樣式和腳本
            document.querySelectorAll('[data-dynamic-style], [data-dynamic-script]').forEach(el => el.remove());

            // 載入新的樣式
            styles.forEach(style => {
                const newStyle = document.createElement('style');
                newStyle.setAttribute('data-dynamic-style', 'true');
                newStyle.textContent = style.textContent;
                document.head.appendChild(newStyle);
            });

            // 載入並執行新的腳本
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                newScript.setAttribute('data-dynamic-script', 'true');
                if (script.src) {
                    newScript.src = script.src;
                    newScript.async = false;
                } else {
                    newScript.textContent = script.textContent;
                }
                document.body.appendChild(newScript);
            });

        } catch (error) {
            console.error('頁面載入失敗:', error);
            contentArea.innerHTML = `<div class="sys-block" style="color: red;">頁面載入失敗: ${error.message}</div>`;
            // 失敗時清除可能殘留的參數
            contentArea.removeAttribute('data-page-params');
        }
    }

    // 【新增】主儀表板 (首頁) 的 HTML 產生函式
    function getMainDashboardHTML() {
        return `
            <div class="dashboard-content">
                <div class="welcome-section">
                    <h1 class="welcome-title">歡迎來到 PixelTribe 管理後台</h1>
                    <p class="welcome-subtitle">請從左側選單選擇您要管理的系統。</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><i class="bi bi-people-fill stat-icon"></i><div class="stat-number" id="membersCount">載入中</div><div class="stat-label">總會員數</div></div>
                    <div class="stat-card"><i class="bi bi-newspaper stat-icon"></i><div class="stat-number" id="newsCount">載入中</div><div class="stat-label">新聞總數</div></div>
                    <div class="stat-card">
                        <i class="bi bi-chat-square-dots-fill stat-icon"></i>
                        <div class="stat-number" id="mainForumPostCount">載入中</div>
                        <div class="stat-label">討論區文章數</div>
                    </div>
                    <div class="stat-card"><i class="bi bi-shop-window stat-icon"></i><div class="stat-number">156</div><div class="stat-label">上架商品數</div></div>
                </div>
                <div class="guide-text">
                    <h3>🚀 快速開始</h3>
                    <p>此管理後台整合了多個核心系統，您可以：<br>
                        • <strong>商城系統</strong>：管理商品、訂單、優惠券等電商功能。<br>
                        • <strong>新聞系統</strong>：發布最新公告、管理使用者評論與檢舉。<br>
                        • <strong>討論區系統</strong>：維護討論區秩序、管理文章與官方公告。<br>
                        • <strong>會員系統</strong>：查詢會員資料並執行管理操作。
                    </p>
                </div>
            </div>
        `;
    }

    // 商城儀表板的 HTML
    function getShopDashboardHTML() {
    return `
        <div class="dashboard-content">
            <div class="welcome-section">
                <h1 class="welcome-title">商城管理中心</h1>
                <p class="welcome-subtitle">這裡是商城系統的數據總覽儀表板。</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><i class="bi bi-box-seam stat-icon"></i><div class="stat-number" id="productCount">載入中...</div><div class="stat-label">商品總數</div></div>
                <div class="stat-card"><i class="bi bi-cart-check stat-icon"></i><div class="stat-number" id="pendingOrderCount">載入中...</div><div class="stat-label">待處理訂單</div></div>
                <div class="stat-card"><i class="bi bi-chat-square-text-fill stat-icon"></i><div class="stat-number" id="commentCount">載入中...</div><div class="stat-label">評論總數</div></div>
                <div class="stat-card"><i class="bi bi-cash-stack stat-icon"></i><div class="stat-number" id="monthlyRevenue">載入中...</div><div class="stat-label">本月營收</div></div>
            </div>
            <div class="guide-text">
                <h3>📋 使用說明</h3>
                <p>請使用左側選單進行各項管理操作。<br>• <strong>產品管理</strong>：管理商品上下架、分類和資訊。<br>• <strong>訂單管理</strong>：處理訂單、出貨與評論。<br>• <strong>評論管理</strong>：管理訂單評論和審核。</p>
            </div>
        </div>
    `;
}

    // 【新增】討論區儀表板的 HTML 產生函式
    function getForumDashboardHTML() {
        return `
            <div class="dashboard-content">
                <div class="welcome-section">
                    <h1 class="welcome-title">討論區管理後台</h1>
                    <p class="welcome-subtitle">這裡是討論區系統的數據總覽儀表板。</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="bi bi-card-list stat-icon"></i>
                        <div class="stat-number" id="forumCount">載入中</div>
                        <div class="stat-label">討論區總數</div>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-file-text-fill stat-icon"></i>
                        <div class="stat-number" id="postCount">載入中</div>
                        <div class="stat-label">文章總數</div>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-chat-left-text-fill stat-icon"></i>
                        <div class="stat-number" id="messageCount">載入中</div>
                        <div class="stat-label">留言總數</div>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-shield-exclamation stat-icon"></i>
                        <div class="stat-number" id="pendingArticleReportCount">載入中</div>
                        <div class="stat-label">待處理文章檢舉</div>
                    </div>
                     <div class="stat-card">
                        <i class="bi bi-shield-slash stat-icon"></i>
                        <div class="stat-number" id="pendingCommentReportCount">載入中</div>
                        <div class="stat-label">待處理留言檢舉</div>
                    </div>
                </div>
                <div class="guide-text">
                    <h3>📋 使用說明</h3>
                    <p>請使用左側選單進行各項管理操作。<br>
                    • <strong>討論區類別管理</strong>：管理討論區的分類。<br>
                    • <strong>討論區管理</strong>：新增、修改或隱藏特定討論區。<br>
                    • <strong>文章/留言管理</strong>：管理使用者發布的內容。<br>
                    • <strong>檢舉審核</strong>：處理使用者提交的文章與留言檢舉。</p>
                </div>
            </div>
        `;
    }


    // 新聞儀表板的 HTML
    function getNewsDashboardHTML() {
        return `
            <div class="dashboard-content">
                <div class="welcome-section">
                    <h1 class="welcome-title">新聞管理後台</h1>
                    <p class="welcome-subtitle">這裡是新聞系統的數據總覽儀表板。</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="bi bi-newspaper stat-icon"></i>
                        <div class="stat-number" id="newsCount">載入中</div>
                        <div class="stat-label">新聞總數</div>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-chat-square-dots-fill stat-icon"></i>
                        <div class="stat-number" id="commentCount">載入中</div>
                        <div class="stat-label">評論總數</div>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-shield stat-icon"></i>
                        <div class="stat-number" id="pendingReportCount">載入中</div>
                        <div class="stat-label">待處理檢舉總數</div>
                    </div>
                </div>
                <div class="guide-text">
                    <h3>📋 使用說明</h3>
                    <p>請使用左側選單進行各項管理操作。<br>
                    • <strong>新聞類別管理</strong>：管理新聞類別修改、新增。<br>
                    • <strong>新聞管理</strong>：管理新聞修改、新增、隱藏。<br>
                    • <strong>新聞評論管理</strong>：管理新聞評論修改、隱藏。<br>
                    • <strong>新聞評論檢舉審核</strong>：新聞評論檢舉處理。</p>
                </div>
            </div>
        `;
    }
    
    
	//會員儀錶板
    function getMemberDashboardHTML() {
        return `
            <div class="dashboard-content">
                <div class="welcome-section">
                    <h1 class="welcome-title">會員系統儀表板</h1>
                    <p class="welcome-subtitle">即時掌握會員數據狀態。</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="bi bi-people-fill stat-icon"></i>
                        <div class="stat-number" id="memberTotalCount">載入中</div>
                        <div class="stat-label">會員總數</div>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-person-x stat-icon"></i>
                        <div class="stat-number" id="memberSuspendedCount">載入中</div>
                        <div class="stat-label">停權會員數</div>
                    </div>
                </div>
                <div class="guide-text">
                    <h3>📋 操作說明</h3>
                    <p>
                        • 會員總數：所有會員總人數。<br>
                        • 停權會員：已被停權無法登入的會員數量。<br>
                    </p>
                </div>
            </div>
        `;
    }

    
    // 佔位頁面的 HTML，用於顯示開發中的頁面
    function getPlaceholderHTML(pageKey, subKey) {
        // ... 此函式內容不變 ...
        const pageTitles = {
            store: '商城系統', news: '新聞系統', forum: '討論區系統', member: '會員系統'
        };
        const subTitles = {
            'toggle': '產品上下架',
            'categories': '產品分類',
            'edit': '編輯產品資訊',
            'orders': '訂單管理',
            'shipping': '產品發貨管理',
            'reviews': '訂單評論管理',
            'coupons': '優惠券管理',
            'dashboard': '儀表板',
            'news-edit': '新聞編輯',
            'comments': '新聞評論管理',
            'reports': '審核檢舉',
            'forums': '討論區管理',
            'posts': '文章管理',
            'forum-comments': '留言管理',
            // 'official': '發布官方文章',
            'categories': '討論區類別管理',
            'query': '會員管理',
            'suspend': '會員停權',
            'article-reports': '文章檢舉審核' // 新增的子選單標題
        };

        const title = pageTitles[pageKey] || '系統';
        const subTitle = subTitles[subKey] || '功能頁面';
        const fullTitle = (subKey === 'dashboard') ? `${title}儀表板` : subTitle;

        return `
            <div class="sys-block">
                <h2 class="sys-subtitle">${fullTitle}</h2>
                <ul>
                    <li><i class="bi bi-tools item-icon"></i>此頁面為 <strong>${fullTitle}</strong> 的管理介面。</li>
                    <li><i class="bi bi-gear-wide-connected item-icon"></i>後續請在此處開發對應功能。</li>
                    <li><i class="bi bi-file-code item-icon"></i>你可以在這裡使用 fetch API 向後端請求資料，並動態渲染表格或表單。</li>
                </ul>
            </div>
        `;
    }

    function handleLogout() {
        window.location.href = '/back-end/adm/AdmLogin.html';
        localStorage.removeItem('adminInfo');
        localStorage.removeItem('jwt');
    }

    function loadMainDashboard(event) {
        if (event) event.preventDefault();
        document.querySelectorAll('.menu-item.active').forEach(item => item.classList.remove('active'));
        document.querySelectorAll('.submenu-item.active').forEach(item => item.classList.remove('active'));
        contentArea.innerHTML = getMainDashboardHTML();

        setTimeout(async () => {
            const token = localStorage.getItem('jwt');
            // [不可變] headers 是 API 驗證的必要部分
            const headers = { Authorization: 'Bearer ' + token };

            // [可變] 根據你 HTML 中的 id 獲取 DOM 元素
            const newsCountEl = document.getElementById('newsCount');
            const forumPostCountEl = document.getElementById('mainForumPostCount'); // 【新增】抓取討論區文章數的元素
			const membersCountEl = document.getElementById('membersCount');
            try {
                // ① 新聞總數 (原有邏輯不變)
                const res1 = await fetch('/api/News/admin/newscount', { headers });
                if (!res1.ok) throw new Error(`(新聞總數 ${res1.status})`);
                const newsCount = await res1.text();
                if (newsCountEl) newsCountEl.innerText = newsCount;

                // ② 討論區文章總數 (【新增】的 fetch 邏輯)
                // [可變] /api/admin/forumpost/count 是你的後端 API 端點，可根據實際情況修改
                const res2 = await fetch('/api/admin/forumpost/count', { headers });
                if (!res2.ok) throw new Error(`(討論區文章數 ${res2.status})`);
                const postCount = await res2.text();
                if (forumPostCountEl) forumPostCountEl.innerText = postCount;
                
                //會員總數
                const res3 = await fetch('/api/members/admin/count', {headers});
                if (!res3.ok) throw new Error(`(會員總數 ${re3.status})`);
                const membersCount = await res3.text();
                if (membersCountEl) membersCountEl.innerText = membersCount;

            } catch (err) {
                console.error('主儀表板數據載入失敗:', err);
                // 【修改】更完整的錯誤處理
                if (newsCountEl) newsCountEl.innerText = '錯誤';
                if (forumPostCountEl) forumPostCountEl.innerText = '錯誤';
            }
        }, 0);
    }

    window.onload = function () {
        loadMainDashboard();
    }
</script>
</body>
</html>