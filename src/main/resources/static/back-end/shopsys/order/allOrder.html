<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單管理後台</title>
    
    <style>
        /* 繼承主頁面的 CSS 變數，確保視覺風格一致 */
        .order-management-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Karla', '微軟正黑體', Arial, sans-serif;
        }

        .order-management-container .page-title-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .order-management-container .page-title-header h2 {
            font-family: 'Karla', sans-serif;
            font-size: 24px;
            color: var(--text-color);
            font-weight: 700;
            margin: 0;
        }

        .order-management-container .control-bar {
            background: var(--component-bg);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .order-management-container .filter-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .order-management-container .filter-select {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            background: var(--component-bg);
            color: var(--text-color);
            transition: border-color 0.2s;
        }
        .order-management-container .filter-select:focus {
            border-color: var(--brand-green);
            outline: none;
        }

        .order-management-container .table-container {
            background: var(--component-bg);
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        .order-management-container .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .order-management-container .table thead {
            background: var(--brand-green-light);
        }

        .order-management-container .table th {
            color: var(--brand-green);
            font-weight: 700;
            text-align: center;
            vertical-align: middle;
            padding: 15px;
            border: none;
        }

        .order-management-container .table td {
            text-align: center;
            vertical-align: middle;
            padding: 12px;
            border-top: 1px solid var(--border-color);
            color: var(--text-color);
        }

        /* 訂單編號連結樣式 */
        .order-management-container .order-link {
            color: var(--brand-green);
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .order-management-container .order-link:hover {
            color: var(--brand-green-hover);
            text-decoration: underline;
        }
        
        /* 訂單專用狀態標籤 */
        .order-management-container .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 500;
        }
        .order-management-container .status-pending { background-color: #f8d7da; color: #721c24; }
        .order-management-container .status-paying { background-color: #d1ecf1; color: #0c5460; }
        .order-management-container .status-processing { background-color: #fff3cd; color: #856404; }
        .order-management-container .status-shipped { background-color: #cce5ff; color: #004085; }
        .order-management-container .status-completed { background-color: #d4edda; color: #155724; }
        .order-management-container .status-failed { background-color: #f8d7da; color: #721c24; }
        .order-management-container .status-cancelled { background-color: #e9ecef; color: #495057; }
        .order-management-container .status-unknown { background-color: #e9ecef; color: #495057; }

        /* 操作按鈕 */
        .order-management-container .action-btn {
            display: inline-block;
            text-decoration: none;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-size: 14px;
        }
        .order-management-container .action-btn:hover {
            background: var(--brand-green-light);
            color: var(--brand-green);
            border-color: var(--brand-green);
        }

        /* 新增按鈕 */
        .order-management-container .action-btn.btn-add {
            background-color: var(--brand-green);
            border-color: var(--brand-green);
            color: white;
            font-weight: bold;
        }
        .order-management-container .action-btn.btn-add:hover {
            background-color: var(--brand-green-hover);
            border-color: var(--brand-green-hover);
        }

        /* 分頁控制項 */
        .order-management-container .pagination-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 20px 0;
        }
        .order-management-container .pagination {
            display: flex;
            padding-left: 0;
            list-style: none;
            margin: 0;
        }
        .order-management-container .pagination-controls .page-item .page-link {
            color: var(--brand-green);
            background-color: var(--component-bg);
            border: 1px solid var(--border-color);
            margin: 0 3px;
            padding: 8px 14px;
            border-radius: 6px;
            transition: all 0.2s;
            text-decoration: none;
            display: block;
        }
        .order-management-container .pagination-controls .page-item.active .page-link {
            z-index: 1;
            color: #fff;
            background-color: var(--brand-green);
            border-color: var(--brand-green);
        }
        .order-management-container .pagination-controls .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #e9ecef;
            border-color: var(--border-color);
        }
        .order-management-container .pagination-controls .page-item .page-link:hover:not(.active) {
            background-color: var(--brand-green-light);
            border-color: var(--brand-green);
        }

        /* 錯誤訊息 */
        .order-management-container #error-message {
            color: #e74c3c;
            background-color: #fbecec;
            border: 1px solid #e74c3c;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            display: none;
        }

        /* Modal 樣式 */
        .order-management-container .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .order-management-container .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .order-management-container .modal-dialog {
            max-width: 95%;
            width: 95%;
            margin: 0;
        }
        
        @media (min-width: 1200px) {
            .order-management-container .modal-dialog {
                max-width: 1400px;
            }
        }
        
        .order-management-container .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .order-management-container .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--brand-green);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .order-management-container .modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }
        
        .order-management-container .btn-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .order-management-container .btn-close:hover {
            opacity: 1;
        }
        
        .order-management-container .modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .order-management-container .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .order-management-container .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .order-management-container .btn-secondary {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .order-management-container .btn-primary {
            background: var(--brand-green);
            border-color: var(--brand-green);
            color: white;
        }
        
        .order-management-container .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .order-management-container .detail-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .order-management-container .detail-item:last-child {
            border-bottom: none;
        }
        .order-management-container .detail-label {
            font-weight: bold;
            color: var(--brand-green);
            margin-bottom: 4px;
            display: inline-block;
        }
        
        /* 表格樣式 */
        .order-management-container .table-responsive {
            overflow-x: auto;
        }
        
        .order-management-container .table-sm th,
        .order-management-container .table-sm td {
            padding: 8px;
            font-size: 14px;
        }
        
        /* 文字樣式 */
        .order-management-container .text-center {
            text-align: center;
        }
        
        .order-management-container .text-danger {
            color: #dc3545;
        }
        
        .order-management-container .text-muted {
            color: #6c757d;
        }
        
        .order-management-container .text-primary {
            color: var(--brand-green);
        }
        
        .order-management-container .text-success {
            color: #28a745;
        }
        
        .order-management-container .text-info {
            color: #17a2b8;
        }
        
        .order-management-container .text-warning {
            color: #ffc107;
        }
        
        .order-management-container .fw-bold {
            font-weight: bold;
        }
        
        .order-management-container .mb-3 {
            margin-bottom: 1rem;
        }
        
        .order-management-container .me-2 {
            margin-right: 0.5rem;
        }
        
        .order-management-container .my-4 {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* 網格系統 */
        .order-management-container .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }
        
        .order-management-container .col-12 {
            flex: 0 0 100%;
            max-width: 100%;
            padding: 0 15px;
        }
        
        .order-management-container .col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
            padding: 0 15px;
        }
        
        @media (min-width: 768px) {
            .order-management-container .col-md-6 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }
        
        /* 星星評分特殊樣式 */
        .order-management-container .star-rating {
            font-size: 16px;
            line-height: 1;
            white-space: nowrap;
        }
        
        .order-management-container .star-rating .star {
            color: #ffc107;
            margin-right: 2px;
        }
        
        .order-management-container .star-rating .star-empty {
            color: #e0e0e0;
            margin-right: 2px;
        }
        
        /* Modal 層級修復 */
        .order-management-container .modal-backdrop {
            display: none !important;
        }
        
        .order-management-container .modal {
            z-index: 9999 !important;
        }
        
        .order-management-container .modal-content {
            z-index: 10000 !important;
            pointer-events: auto !important;
        }
        
        .order-management-container .modal-body {
            pointer-events: auto !important;
            background: white !important;
            color: #333 !important;
        }
        
        .order-management-container .detail-item span {
            color: #333 !important;
        }
        
        .order-management-container .modal-body .table th {
            background-color: #f8f9fa !important;
            color: #333 !important;
        }
        
        .order-management-container .modal-body .table td {
            background: white !important;
            color: #333 !important;
        }
    </style>
</head>
<body>

<div class="order-management-container">
    <div class="page-title-header">
        <h2><i class="bi bi-receipt-cutoff me-2"></i>訂單管理</h2>
    </div>

    <div class="control-bar">
        <div>
            <a href="#" onclick="OrderManager.addNewOrder()" class="action-btn btn-add">＋ 新增訂單</a>
        </div>
        <div class="filter-group">
            <div>
                <label for="itemsPerPageFilter">每頁顯示：</label> 
                <select id="itemsPerPageFilter" class="filter-select" onchange="OrderManager.changeItemsPerPage()">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                </select>
            </div>
            <div>
                <label for="statusFilter">篩選狀態：</label>
                <select id="statusFilter" class="filter-select" onchange="OrderManager.filterByStatus()">
                    <option value="">全部狀態</option>
                    <option value="PENDING,等待付款">等待付款</option>
                    <option value="PAYING,付款處理中">付款處理中</option>
                    <option value="PROCESSING,處理中">處理中</option>
                    <option value="SHIPPED,已付款">已付款</option>
                    <option value="COMPLETED,已完成">已完成</option>
                    <option value="FAILED,處理失敗">處理失敗</option>
                    <option value="CANCELLED,已取消">已取消</option>
                </select>
            </div>
        </div>
    </div>

    <div id="error-message"></div>

    <div class="table-container">
        <table class="table">
            <thead>
            <tr>
                <th>訂單編號</th>
                <th>會員姓名</th>
                <th>會員信箱</th>
                <th>訂購時間</th>
                <th>訂單狀態</th>
                <th>訂單總額</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="orderTableBody">
            <tr>
                <td colspan="7" style="text-align:center; padding: 40px;">載入中...</td>
            </tr>
            </tbody>
        </table>
    </div>
    
    <!-- 訂單明細 Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-wide">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailModalLabel">
                        <i class="bi bi-file-text me-2"></i>訂單明細
                    </h5>
                    <button type="button" class="btn-close" onclick="OrderManager.closeModal()">×</button>
                </div>
                <div class="modal-body">
                    <div id="orderDetailContent">
                        <div class="text-center">
                            <i class="bi bi-arrow-clockwise me-2"></i>載入中...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="OrderManager.closeModal()">關閉</button>
                    <button type="button" class="btn btn-primary" onclick="OrderManager.printOrder()">
                        <i class="bi bi-printer me-1"></i>列印
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nav id="paginationContainer" class="pagination-controls"></nav>
</div>

<script>
    (function() {
        'use strict';

        // --- API 設定 ---
        const API_BASE = '/api/admin';
        
        // --- DOM 元素 ---
        const tableBody = document.getElementById('orderTableBody');
        const errorMessageDiv = document.getElementById('error-message');
        const paginationContainer = document.getElementById('paginationContainer');
        const itemsPerPageFilter = document.getElementById('itemsPerPageFilter');
        const statusFilter = document.getElementById('statusFilter');

        // --- 狀態管理 ---
        let currentPage = 0; // 後端從 0 開始
        let itemsPerPage = 10;
        let totalPages = 0;
        let totalElements = 0;
        let currentFilter = '';

        // --- 核心功能 ---
        
        /**
         * 載入訂單資料 (使用後台分頁 API)
         */
        async function loadOrders() {
            const token = localStorage.getItem('jwt');
            if (!token) {
                console.error('JWT Token 不存在，請重新登入');
                showError(new Error('請重新登入'));
                return;
            }

            try {
                showLoading();
                
                const url = new URL(`${API_BASE}/paged`, window.location.origin);
                url.searchParams.append('page', currentPage);
                url.searchParams.append('size', itemsPerPage);
                url.searchParams.append('sortBy', 'orderDatetime');
                url.searchParams.append('sortDir', 'DESC');

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP 錯誤！狀態: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.data) {
                    const pageData = result.data;
                    totalPages = pageData.totalPages;
                    totalElements = pageData.totalElements;
                    
                    renderTableBody(pageData.orders || []);
                    renderPaginationControls();
                    hideError();
                } else {
                    throw new Error('資料格式錯誤');
                }

            } catch (error) {
                console.error('載入訂單失敗:', error);
                showError(error);
            }
        }

        /**
         * 按狀態篩選 - 支援中英文狀態值
         */
        async function filterByStatus() {
            const selectedValue = statusFilter.value;
            currentPage = 0; // 重置到第一頁
            
            if (!selectedValue) {
                // 沒有篩選，使用一般分頁查詢
                currentFilter = '';
                await loadOrders();
                return;
            }

            // 解析中英文狀態值 "PENDING,等待付款"
            const statusOptions = selectedValue.split(',');
            const englishStatus = statusOptions[0];
            const chineseStatus = statusOptions[1];
            
            currentFilter = selectedValue;

            const token = localStorage.getItem('jwt');
            if (!token) {
                showError(new Error('請重新登入'));
                return;
            }

            try {
                showLoading();
                
                // 先嘗試英文狀態值
                let response = await fetch(`${API_BASE}/status/${englishStatus}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let orders = [];
                
                if (response.ok) {
                    orders = await response.json();
                } else {
                    // 如果英文狀態查詢失敗，嘗試從所有訂單中篩選中文狀態
                    console.log('嘗試中文狀態篩選...');
                    
                    const allResponse = await fetch(`${API_BASE}/all`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (allResponse.ok) {
                        const allOrders = await allResponse.json();
                        // 篩選匹配中文或英文狀態的訂單
                        orders = allOrders.filter(order => 
                            order.orderStatus === englishStatus || 
                            order.orderStatus === chineseStatus
                        );
                    }
                }
                
                // 手動分頁處理
                totalElements = orders.length;
                totalPages = Math.ceil(totalElements / itemsPerPage);
                
                const startIndex = currentPage * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedOrders = orders.slice(startIndex, endIndex);
                
                renderTableBody(paginatedOrders);
                renderPaginationControls();
                hideError();

            } catch (error) {
                console.error('篩選訂單失敗:', error);
                showError(error);
            }
        }

        /**
         * 渲染表格內容
         */
        function renderTableBody(orders) {
            if (!orders || orders.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center; padding: 40px;">
                            找不到符合條件的訂單
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = orders.map(order => `
                <tr>
                    <td>
                        <a href="#" class="order-link" onclick="OrderManager.showOrderDetail('${order.orderNo}')">
                            ${order.orderNo}
                        </a>
                    </td>
                    <td>${order.memName || '未知'}</td>
                    <td>${order.memEmail || '無'}</td>
                    <td>${formatDateTime(order.orderDatetime)}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(order.orderStatus)}">
                            ${getStatusDisplayName(order.orderStatus)}
                        </span>
                    </td>
                    <td>NT$ ${(order.orderTotal || 0).toLocaleString()}</td>
                    <td>
                        <button class="action-btn" onclick="OrderManager.editOrder('${order.orderNo}')">
                            <i class="bi bi-pencil-square"></i> 修改
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * 渲染分頁控制項
         */
        function renderPaginationControls() {
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '<ul class="pagination">';

            // 上一頁按鈕
            paginationHTML += `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); OrderManager.changePage(${currentPage - 1})">上一頁</a>
                </li>`;

            // 頁碼按鈕
            for (let i = 0; i < totalPages; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); OrderManager.changePage(${i})">${i + 1}</a>
                    </li>`;
            }

            // 下一頁按鈕
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); OrderManager.changePage(${currentPage + 1})">下一頁</a>
                </li>`;

            paginationHTML += '</ul>';
            
            // 加上統計資訊
            paginationHTML += `
                <div style="margin-left: 20px; color: var(--text-muted); font-size: 14px;">
                    顯示第 ${currentPage * itemsPerPage + 1} - ${Math.min((currentPage + 1) * itemsPerPage, totalElements)} 筆，
                    共 ${totalElements} 筆資料
                </div>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
        }

        /**
         * 顯示訂單明細
         */
        async function showOrderDetail(orderNo) {
            const token = localStorage.getItem('jwt');
            if (!token) {
                showError(new Error('請重新登入'));
                return;
            }

            // 顯示 Modal
            const modal = document.getElementById('orderDetailModal');
            modal.classList.add('show');
            modal.style.display = 'flex';
            
            // 重置內容
            document.getElementById('orderDetailContent').innerHTML = `
                <div class="text-center">
                    <i class="bi bi-arrow-clockwise me-2"></i>載入訂單明細中...
                </div>
            `;

            try {
                // 同時載入訂單資訊和訂單項目
                const [orderResponse, itemsResponse] = await Promise.all([
                    fetch(`/api/orders/${orderNo}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`/api/admin/orderitem/order/${orderNo}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!orderResponse.ok || !itemsResponse.ok) {
                    throw new Error('載入訂單資料失敗');
                }

                const orderDetail = await orderResponse.json();
                const orderItems = await itemsResponse.json();
                
                orderDetail.orderItems = orderItems;
                displayOrderDetail(orderDetail);

            } catch (error) {
                console.error('載入訂單明細失敗:', error);
                document.getElementById('orderDetailContent').innerHTML = `
                    <div class="text-danger text-center">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        載入失敗：${error.message}
                    </div>
                `;
            }
        }

        /**
         * 顯示訂單明細內容
         */
        function displayOrderDetail(order) {
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3"><i class="bi bi-info-circle me-2"></i>基本資訊</h6>
                        <div class="detail-item">
                            <span class="detail-label">訂單編號：</span>
                            <span>${order.orderNo}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">會員編號：</span>
                            <span>${order.memNo || '訪客'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">聯絡信箱：</span>
                            <span>${order.contactEmail || '無'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">訂購時間：</span>
                            <span>${formatDateTime(order.orderDatetime)}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success mb-3"><i class="bi bi-currency-dollar me-2"></i>金額資訊</h6>
                        <div class="detail-item">
                            <span class="detail-label">訂單狀態：</span>
                            <span class="status-badge ${getStatusClass(order.orderStatus)}">
                                ${getStatusDisplayName(order.orderStatus)}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">訂單總額：</span>
                            <span class="fw-bold text-success">NT$ ${order.orderTotal ? order.orderTotal.toLocaleString() : '0'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">優惠券：</span>
                            <span>${order.couponWalletNo || '無'}</span>
                        </div>
                    </div>
                </div>  
                
                <hr class="my-4">
                
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-info mb-3"><i class="bi bi-bag me-2"></i>訂單項目</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead style="background-color: #f8f9fa; color: #333;">
                                    <tr>
                                        <th style="color: #333;">項次</th>
                                        <th style="color: #333;">產品名稱</th>
                                        <th style="color: #333;">產品價格</th>
                                        <th style="color: #333;">訂購數量</th>
                                        <th style="color: #333;">小計</th>
                                        <th style="color: #333;">評價星星數</th>
                                        <th style="color: #333;">評論內容</th>
                                        <th style="color: #333;">評論時間</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${generateOrderItemsHTML(order.orderItems)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('orderDetailContent').innerHTML = content;
        }

        /**
         * 產生訂單項目HTML
         */
        function generateOrderItemsHTML(orderItems) {
            if (!orderItems || orderItems.length === 0) {
                return '<tr><td colspan="8" class="text-muted text-center">此訂單暫無商品項目</td></tr>';
            }

            return orderItems.map((item, index) => `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td>${item.proName || '商品名稱'}</td>
                    <td>NT$ ${item.proPrice ? item.proPrice.toLocaleString() : '0'}</td>
                    <td>${item.orderAmount || '0'}</td>
                    <td>NT$ ${item.subTotal ? item.subTotal.toLocaleString() : calculateSubtotal(item.proPrice, item.orderAmount)}</td>
                    <td>${generateStarRating(item.proStar)}</td>
                    <td>${item.productComment || '無評論'}</td>
                    <td>${formatDateTime(item.productCommentCrdate) || '未評論'}</td>
                </tr>
            `).join('');
        }

        /**
         * 產生星星評分
         */
        function generateStarRating(rating) {
            if (!rating || rating === 0) {
                return '<span class="text-muted">未評分</span>';
            }
            
            let stars = '<div class="star-rating">';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="star">★</span>';
                } else {
                    stars += '<span class="star-empty">☆</span>';
                }
            }
            stars += ` <small class="text-muted">(${rating}/5)</small></div>`;
            return stars;
        }

        /**
         * 計算小計
         */
        function calculateSubtotal(price, quantity) {
            const subtotal = (price || 0) * (quantity || 0);
            return subtotal.toLocaleString();
        }

        // --- 事件處理函式 ---
        
        function changeItemsPerPage() {
            itemsPerPage = parseInt(itemsPerPageFilter.value);
            currentPage = 0;
            if (currentFilter) {
                filterByStatus();
            } else {
                loadOrders();
            }
        }

        function changePage(page) {
            if (page < 0 || page >= totalPages) return;
            currentPage = page;
            
            if (currentFilter) {
                filterByStatus();
            } else {
                loadOrders();
            }
        }

        function closeModal() {
            const modal = document.getElementById('orderDetailModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        function addNewOrder() {
            // 載入新增訂單頁面
            if (typeof loadExternalPage === 'function') {
                loadExternalPage('../shopsys/order/addOrder.html');
            } else {
                window.location.href = 'addOrder.html';
            }
        }

        function editOrder(orderNo) {
            // 載入修改訂單頁面，並傳遞訂單編號參數
            if (typeof loadExternalPage === 'function') {
                loadExternalPage(`../shopsys/order/editOrder.html?orderNo=${orderNo}`);
            } else {
                window.location.href = `editOrder.html?orderNo=${orderNo}`;
            }
        }

        function printOrder() {
            window.print();
        }

        // --- 輔助函式 ---
        
        function showLoading() {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center; padding: 40px;">
                        <i class="bi bi-arrow-clockwise me-2"></i>載入中...
                    </td>
                </tr>
            `;
        }

        function showError(error) {
            console.error('訂單管理錯誤:', error);
            errorMessageDiv.style.display = 'block';
            errorMessageDiv.innerHTML = `
                <strong>資料載入失敗！</strong> ${error.message}
            `;
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center; padding: 40px; color: #e74c3c;">
                        載入失敗，請重試
                    </td>
                </tr>
            `;
        }

        function hideError() {
            errorMessageDiv.style.display = 'none';
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            try {
                return new Date(dateTimeStr).toLocaleString('zh-TW', { 
                    hour12: false,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateTimeStr;
            }
        }

        /**
         * 統一狀態值轉換函式 - 將任何狀態值轉為標準中文顯示
         */
        function normalizeStatusToDisplay(status) {
            if (!status) return '未知';
            
            // 標準化為大寫進行比較
            const upperStatus = status.toString().toUpperCase();
            
            switch(upperStatus) {
                case 'PENDING':
                case '等待付款':
                    return '等待付款';
                    
                case 'PAYING':
                case '付款處理中':
                    return '付款處理中';
                    
                case 'PROCESSING':
                case '處理中':
                    return '處理中';
                    
                case 'SHIPPED':
                case '已付款':
                case '已出貨':
                    return '已付款';
                    
                case 'COMPLETED':
                case '已完成':
                    return '已完成';
                    
                case 'FAILED':
                case '處理失敗':
                case 'PAYMENT_FAILED':
                    return '處理失敗';
                    
                case 'CANCELLED':
                case '已取消':
                    return '已取消';
                    
                default:
                    return status; // 返回原始值
            }
        }

        /**
         * 根據狀態值獲取對應的CSS類別
         */
        function getStatusClass(status) {
            if (!status) return 'status-unknown';
            
            const normalizedStatus = normalizeStatusToDisplay(status);
            
            switch(normalizedStatus) {
                case '等待付款': return 'status-pending';
                case '付款處理中': return 'status-paying';
                case '處理中': return 'status-processing';
                case '已付款': return 'status-shipped';
                case '已完成': return 'status-completed';
                case '處理失敗': return 'status-failed';
                case '已取消': return 'status-cancelled';
                default: return 'status-unknown';
            }
        }

        /**
         * 統一狀態顯示名稱 - 直接使用標準化函式
         */
        function getStatusDisplayName(status) {
            return normalizeStatusToDisplay(status);
        }

        // --- 全域暴露 ---
        window.OrderManager = {
            showOrderDetail,
            closeModal,
            addNewOrder,
            editOrder,
            printOrder,
            filterByStatus,
            changeItemsPerPage,
            changePage
        };

        // --- 初始化 ---
        loadOrders();

    })();
</script>

</body>
</html>