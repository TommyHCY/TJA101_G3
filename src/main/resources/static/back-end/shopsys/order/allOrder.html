<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單管理後台</title>
    <style>
        /* --- 核心：樣式完全與 allForum.html 同步 --- */
        .order-management-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-title-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title-header h2 {
            font-family: 'Karla', sans-serif;
            font-size: 24px;
            color: var(--text-color);
            font-weight: 700;
            margin: 0;
        }

        .control-bar {
            background: var(--component-bg);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .filter-select {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            background: var(--primary-bg);
            color: var(--text-color);
            transition: border-color 0.2s;
        }
        .filter-select:focus {
            border-color: var(--brand-green);
            outline: none;
        }

        .table-container {
            background: var(--component-bg);
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .table thead {
            background: var(--brand-green-light);
        }

        .table th {
            color: var(--brand-green);
            font-weight: 700;
            text-align: center;
            vertical-align: middle;
            padding: 15px;
            border: none;
        }

        .table td {
            text-align: center;
            vertical-align: middle;
            padding: 12px;
            border-top: 1px solid var(--border-color);
            color: var(--text-color);
        }

        /* 訂單專用狀態標籤 (保留獨特性) */
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 500;
        }
        .status-processing { background-color: #fff3cd; color: #856404; }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-shipped { background-color: #d1ecf1; color: #0c5460; }
        .status-unknown { background-color: #e9ecef; color: #495057; }


        /* 操作按鈕 (與 allForum.html 統一) */
        .action-btn {
            display: inline-block;
            text-decoration: none;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 15px; /* <-- 修改：統一 padding */
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .action-btn:hover {
            background: var(--brand-green-light);
            color: var(--brand-green);
            border-color: var(--brand-green);
        }

        /* 分頁控制項 (與 allForum.html 統一) */
        .pagination-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 20px 0;
        }
        .pagination {
            display: flex;
            padding-left: 0;
            list-style: none;
            margin: 0;
        }
        .pagination-controls .page-item .page-link {
            color: var(--brand-green);
            background-color: var(--component-bg);
            border: 1px solid var(--border-color);
            margin: 0 3px;
            padding: 8px 14px;
            border-radius: 6px;
            transition: all 0.2s;
            text-decoration: none;
            display: block;
        }
        .pagination-controls .page-item.active .page-link {
            z-index: 1;
            color: #fff;
            background-color: var(--brand-green);
            border-color: var(--brand-green);
        }
        .pagination-controls .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #e9ecef;
            border-color: var(--border-color);
        }
        .pagination-controls .page-item .page-link:hover:not(.active) {
            background-color: var(--brand-green-light);
            border-color: var(--brand-green);
        }

        /* 錯誤訊息 (從 allForum.html 引入) */
        #error-message {
            color: #e74c3c;
            background-color: #fbecec;
            border: 1px solid #e74c3c;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            display: none;
        }

        /* 新增按鈕，使用主模板主題色 */
        .action-btn.btn-add {
            background-color: var(--brand-green);
            border-color: var(--brand-green);
            color: white;
            font-weight: bold;
        }
        .action-btn.btn-add:hover {
            background-color: var(--brand-green-hover);
            border-color: var(--brand-green-hover);
        }
    </style>
</head>
<body>

<div class="order-management-container">
    <div class="page-title-header">
        <h2><i class="bi bi-receipt-cutoff me-2"></i>訂單管理</h2>
    </div>

    <div class="control-bar">
        <div>
            <a href="addOrder.html" class="action-btn btn-add">＋ 新增訂單</a>
        </div>
        <div class="filter-group">
            <div>
                <label for="itemsPerPageFilter">每頁顯示：</label> <select id="itemsPerPageFilter" class="filter-select" onchange="changeItemsPerPage()">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
            </select>
            </div>
            <div>
                <label for="statusFilter">篩選狀態：</label>
                <select id="statusFilter" class="filter-select" onchange="filterByStatus()">
                    <option value="">全部狀態</option>
                    <option value="處理中">處理中</option>
                    <option value="已出貨">已出貨</option>
                    <option value="已完成">已完成</option>
                </select>
            </div>
        </div>
    </div>

    <div id="error-message"></div>

    <div class="table-container">
        <table class="table">
            <thead>
            <tr>
                <th>訂單編號</th>
                <th>會員編號</th>
                <th>訂購時間</th>
                <th>訂單狀態</th>
                <th>訂單總額</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="orderTableBody">
            <tr>
                <td colspan="6" style="text-align:center; padding: 40px;">載入中...</td>
            </tr>
            </tbody>
        </table>
    </div>

    <nav id="paginationContainer" class="pagination-controls"></nav>
</div>

<script>
    // 使用 IIFE (Immediately Invoked Function Expression) 避免污染全域範疇
    (function() {
        // --- 變數定義區 ---
        const apiUrl = '/api/orders'; // 不可變：後端 API 端點。使用 const 更安全

        // 可變：這些是 DOM 元素的引用
        const tableBody = document.getElementById('orderTableBody');
        const errorMessageDiv = document.getElementById('error-message');
        const paginationContainer = document.getElementById('paginationContainer');
        const itemsPerPageFilter = document.getElementById('itemsPerPageFilter');
        const statusFilter = document.getElementById('statusFilter');

        // 可變：應用程式狀態變數
        let allOrdersData = []; // 存放從 API 獲取的原始訂單資料
        let currentPage = 1;
        let itemsPerPage = 10;

        // --- 核心功能函式 ---

        /**
         * @description 初始化函式，從 API 獲取資料
         * @modification 使用 async/await 提高可讀性
         */
        async function loadOrders() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤！ 狀態: ${response.status}`);
                }
                allOrdersData = await response.json();
                itemsPerPage = parseInt(itemsPerPageFilter.value) || 10;
                currentPage = 1;
                updateDisplay();
            } catch (error) {
                // showError 是從 allForum.html 引入的更優雅的錯誤處理方式
                showError(error);
            }
        }

        /**
         * @description 更新頁面顯示，包含表格和分頁
         */
        function updateDisplay() {
            const currentStatusFilter = statusFilter.value;
            // 根據狀態篩選資料
            const filteredData = currentStatusFilter
                ? allOrdersData.filter(order => order.orderStatus === currentStatusFilter)
                : [...allOrdersData];

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            renderTableBody(paginatedData);
            renderPaginationControls(filteredData.length);
        }

        /**
         * @description 渲染表格內容
         * @param {Array} orders - 要顯示在當前頁面的訂單資料
         */
        function renderTableBody(orders) {
            tableBody.innerHTML = '';

            // 常見錯誤：若傳入的 orders 是空的，沒有做處理會顯示空白畫面。
            // 解法：判斷陣列長度，若為 0 則顯示提示訊息。
            if (!orders || orders.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px;">找不到符合條件的訂單</td></tr>`;
                return;
            }

            // 此處的 order 是迴圈中的區域變數
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.orderNo || 'N/A'}</td>
                    <td>${order.memNo || '訪客'}</td>
                    <td>${formatDateTime(order.orderDatetime)}</td>
                    <td><span class="status-badge ${getStatusClass(order.orderStatus)}">${order.orderStatus || '未知'}</span></td>
                    <td>$${(order.orderTotal || 0).toLocaleString()}</td>
                    <td>
                        <button class="action-btn" onclick="editOrder('${order.orderNo}')">
                            <i class="bi bi-pencil-square"></i> 修改
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * @description 渲染分頁控制項
         * @param {number} totalItems - 篩選後的總資料筆數
         */
        function renderPaginationControls(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '<ul class="pagination">';

            // 上一頁按鈕
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); changePage(${currentPage - 1})">上一頁</a>
                </li>`;

            // 頁碼按鈕
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); changePage(${i})">${i}</a>
                    </li>`;
            }

            // 下一頁按鈕
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); changePage(${currentPage + 1})">下一頁</a>
                </li>`;

            paginationHTML += '</ul>';
            paginationContainer.innerHTML = paginationHTML;
        }

        // --- 事件處理函式 ---
        // 不可變：以下函式名稱需與 HTML 中的 onchange, onclick 對應，所以名稱是固定的
        window.filterByStatus = function() {
            currentPage = 1;
            updateDisplay();
        }

        window.changeItemsPerPage = function() {
            itemsPerPage = parseInt(itemsPerPageFilter.value);
            currentPage = 1;
            updateDisplay();
        }

        window.changePage = function(page) {
            const currentStatusFilter = statusFilter.value;
            const filteredData = currentStatusFilter
                ? allOrdersData.filter(order => order.orderStatus === currentStatusFilter)
                : allOrdersData;
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);

            if (page < 1 || page > totalPages) return;

            currentPage = page;
            updateDisplay();
        }

        // 這兩個函式是訂單頁專有的，予以保留
        window.addNewOrder = function() {
            alert('新增訂單功能開發中...');
        }
        window.editOrder = function(orderNo) {
            alert('準備修改訂單：' + orderNo + '\n詳細功能開發中...');
        }


        // --- 輔助函式 ---
        function showError(error) {
            console.error('無法獲取訂單資料:', error);
            errorMessageDiv.style.display = 'block';
            errorMessageDiv.innerHTML = `<strong>資料載入失敗！</strong> 請檢查後端服務是否啟動及 API 是否正確。<br>詳細錯誤: ${error.message}`;
            tableBody.innerHTML = ''; // 清空表格的 "載入中" 訊息
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            try {
                // 與 allForum 統一使用 toLocaleString()
                return new Date(dateTimeStr).toLocaleString('zh-TW', { hour12: false });
            } catch (e) {
                return dateTimeStr;
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case '處理中': return 'status-processing';
                case '已完成': return 'status-completed';
                case '已出貨': return 'status-shipped';
                default: return 'status-unknown';
            }
        }

        // --- 初始化頁面 ---
        loadOrders();

    })();
</script>

</body>
</html>