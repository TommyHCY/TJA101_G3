<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApexForum - News Demo (API)</title>

    <!-- ============================================== -->
    <!-- Style sheets (絕對路徑，以同主機 /assets 為根) -->
    <!-- ============================================== -->
    <link rel="stylesheet" href="/assets/vendors/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/vendors/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="/assets/vendors/simplebar/simplebar.min.css">
    <link rel="stylesheet" href="/assets/vendors/aos/aos.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/responsive.css">

    <script>
        /* 第一次載入時決定明暗主題 */
        const saved = localStorage.getItem('theme');
        const theme = saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
    </script>
</head>
<body>

<!-- ================== 內容區（節錄） ================== -->
<section class="vine-top">
    <div class="container">
        <!-- 動態新聞卡片插入點 -->
        <div id="news-list" class="row gy-4 mt-5"></div>
    </div>
</section>

<!-- ============================================== -->
<!-- Scripts                                         -->
<!-- ============================================== -->
<script src="/assets/vendors/jquery/jquery.min.js"></script>
<script src="/assets/vendors/bootstrap/bootstrap.bundle.js"></script>
<script src="/assets/vendors/popper/popper.min.js"></script>
<script src="/assets/vendors/simplebar/simplebar.min.js"></script>
<script src="/assets/vendors/aos/aos.js"></script>
<script src="/assets/js/main.js"></script>

<!-- =========== 動態載入新聞（避免 CORS） =========== -->
<script>
    /**
     * 注意：全部採用「相對路徑」或「以 / 開頭」的**同源**請求，
     * 避免 localhost 與 127.0.0.1 混用造成 CORS。
     * 若前後端分離在不同網域 → 請在後端加 CORS 設定。
     */

    document.addEventListener('DOMContentLoaded', () => {
        // 1. 取新聞清單（同源，相對路徑即可）
        fetch('/api/News/allAll?page=0&size=6')
            .then(res => {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(async page => {
                const newsArr = page.content || [];
                // 2. 平行取每則首圖
                const newsWithImg = await Promise.all(
                    newsArr.map(async n => {
                        try {
                            const imgRes = await fetch(`/api/news/image/News/${n.id}`);
                            const imgList = imgRes.ok ? await imgRes.json() : [];
                            const firstImg = imgList.length ? imgList[0].imgUrl : '/assets/img/placeholder.jpg';
                            return { ...n, cover:firstImg };
                        } catch (e){
                            return { ...n, cover:'/assets/img/placeholder.jpg' };
                        }
                    })
                );
                renderNews(newsWithImg);
            })
            .catch(err => console.error('載入新聞失敗', err));
    });

    function renderNews(list){
        const container = document.getElementById('news-list');
        container.innerHTML = list.map(n => `
    <div class="col-md-6 col-lg-4">
      <article class="card h-100 shadow-sm">
        <img src="${n.cover}" class="card-img-top" alt="${n.newsTit}">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${n.newsTit}</h5>
          <p class="card-text text-truncate">${stripHtml(n.newsCon)}</p>
          <a href="/news/${n.id}" class="btn btn-mint mt-auto">閱讀更多</a>
        </div>
      </article>
    </div>
  `).join('');
    }

    function stripHtml(html){
        const div = document.createElement('div');
        div.innerHTML = html || '';
        return div.textContent || div.innerText || '';
    }
</script>

</body>
</html>
