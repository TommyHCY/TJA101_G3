<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>會員中心 - Pixel Tribe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap & icons -->
<link rel="stylesheet"
	href="/assets/vendors/bootstrap/bootstrap.min.css">
<link rel="stylesheet"
	href="/assets/vendors/bootstrap-icons/bootstrap-icons.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/responsive.css">
<style>
:root {
	--main-green: #25945a;
	--main-green-hover: #1e7b4c;
	--profile-title: #9e8969;
}

body {
	background: white;
	padding-top: 100px;
}

.member-center-card {
	max-width: 600px;
	margin: auto;
	border-radius: 16px;
	box-shadow: 0 2px 12px #0001;
}

.avatar-lg {
	width: 80px;
	height: 80px;
	border-radius: 50%;
	object-fit: cover;
	margin-left: 0;
	margin-right: 24px;
}

.profile-list {
	display: grid;
	grid-template-columns: 92px 1fr;
	gap: 16px 0;
	align-items: center;
	margin-bottom: 0;
}

.profile-list dt {
	color: var(--profile-title);
	font-weight: 600;
	text-align: left;
	font-size: 1.15rem;
	padding: 0;
	margin: 0;
	line-height: 2.1;
	grid-column: 1;
	align-self: center;
}

.profile-list dd {
	grid-column: 2;
	margin: 0;
	padding: 0;
	width: 100%;
	min-width: 0;
	align-self: center;
	display: flex;
	align-items: center;
}

.profile-row {
	display: flex;
	align-items: flex-start;
	margin-bottom: 16px;
}

.profile-row dt {
	color: var(--profile-title);
	width: 84px;
	min-width: 84px;
	font-weight: 600;
	text-align: left;
	padding-top: 10px;
	flex-shrink: 0;
}

.profile-row dd {
	flex: 1;
	margin-left: 0;
	display: flex;
	align-items: center;
}

.profile-list input.edit-field {
	width: 100%;
	min-width: 80px;
	margin: 0;
	font-size: 1.1rem;
	padding: 8px 12px;
	border-radius: 8px;
	border: 1px solid #dee2e6;
	background: #fff;
	box-shadow: none;
	line-height: 1.45;
}

.tab-btn {
	border: none;
	background: none;
	color: #8a7b62;
	font-weight: 500;
	margin-right: 16px;
	font-size: 1.06rem;
}

.tab-btn.active {
	color: var(--main-green);
	border-bottom: 2px solid var(--main-green);
}

.member-tabs {
	border-bottom: 1px solid #eee;
	margin-bottom: 22px;
	padding-bottom: 10px;
}

.card-section-title {
	font-size: 1.15rem;
	color: #6c584c;
	font-weight: 700;
	margin-bottom: 12px;
}
/* 主色按鈕 */
.btn-main {
	color: #fff !important;
	background: var(--main-green) !important;
	border: none !important;
}

.btn-main:focus, .btn-main:hover, .btn-main:active, .btn-main:disabled {
	background: var(--main-green-hover) !important;
	color: #fff !important;
	border: none !important;
}

.profile-edit-btns .btn {
	min-width: 90px;
	margin-left: 8px;
}

.profile-edit-btns .btn:first-child {
	margin-left: 0;
}

.profile-edit-btns {
	text-align: right;
}
/* RWD */
@media ( max-width : 600px) {
	.profile-list {
		grid-template-columns: 1fr;
	}
	.profile-list dt, .profile-list dd {
		grid-column: 1;
	}
	.profile-row {
		flex-direction: column;
		align-items: stretch;
	}
	.profile-row dt {
		padding-top: 0;
		margin-bottom: 6px;
	}
	.profile-row dd {
		width: 100%;
	}
}

#resetPwdForm .btn-main {
	color: #fff !important;
}

.vine-navbar.fixed-top {
	background: #fff !important;
	box-shadow: 0 2px 12px #0001 !important;
	z-index: 1030;
}
</style>
</head>
<body>
	<!-- 動態載入 header -->
	<div id="header-placeholder"></div>

	<!-- 上方按鈕連結至會員中心各區塊 -->
	<div class="container" style="padding-bottom: 60px;">
		<div
			class="member-tabs d-flex justify-content-center mt-3 mb-4 d-none d-md-flex">
			<button class="tab-btn active" data-tab="profile">
				<i class="bi bi-person me-1"></i>個人資料
			</button>
			<button class="tab-btn" data-tab="orders">
				<i class="bi bi-receipt me-1"></i>過去訂單
			</button>
			<button class="tab-btn" data-tab="coupons">
				<i class="bi bi-ticket me-1"></i>優惠券
			</button>
			<button class="tab-btn" data-tab="collections">
				<i class="bi bi-bookmarks me-1"></i>收藏文章
			</button>
		</div>
		<div id="memberMainArea"></div>
	</div>

	<!-- 動態載入 footer -->
	<div id="footer-placeholder"></div>
	<script src="/assets/js/global-loader.js"></script>
	<script src="/assets/vendors/bootstrap/bootstrap.bundle.js"></script>
	<script>
	document.addEventListener('DOMContentLoaded', async function () {
		  const jwt = localStorage.getItem('jwt');
		  const memberInfoRaw = localStorage.getItem('memberInfo');
		  let memberInfo = null;
		  let memberId = null;

		  function isJwtExpired(token) {
		    try {
		      const payload = JSON.parse(atob(token.split('.')[1]));
		      if (!payload.exp) return false;
		      const now = Math.floor(Date.now() / 1000);
		      return payload.exp < now;
		    } catch (e) {
		      return true;
		    }
		  }

		  if (!jwt || !memberInfoRaw || isJwtExpired(jwt)) {
		    alert('請先登入會員');
		    window.location.href = '/front-end/mem/MemberLogin.html';
		    return;
		  }
		  try {
		    memberInfo = JSON.parse(memberInfoRaw);
		    memberId = memberInfo.id;
		  } catch (e) {
		    alert('找不到會員資訊，請重新登入');
		    window.location.href = '/front-end/mem/MemberLogin.html';
		    return;
		  }
		  if (!memberId) {
		    alert('找不到會員資訊，請重新登入');
		    window.location.href = '/front-end/mem/MemberLogin.html';
		    return;
		  }

		  let memberProfileDTO = null;
		  try {
		    const res = await fetch(`/api/members/profile/${memberId}`, {
		      method: 'GET',
		      headers: { 'Authorization': 'Bearer ' + jwt }
		    });
		    if (!res.ok) throw new Error('無權限或已登出');
		    memberProfileDTO = await res.json();
		  } catch (e) {
		    alert('登入已失效，請重新登入');
		    localStorage.removeItem('jwt');
		    localStorage.removeItem('memberInfo');
		    window.location.href = '/front-end/mem/MemberLogin.html';
		    return;
		  }

		  window.memberProfile = memberProfileDTO;

		  const memberViews = {
		    profile: function (member, editMode = false) {
		      const avatarSrc = `/images/memberAvatar/mem${memberInfo.id}.png`;
		      if (!editMode) {
		        return `
		          <div class="member-center-card mb-4 bg-white">
		            <div class="card-body py-4 px-4">
		              <div class="d-flex align-items-center mb-3">
		                <img src="${avatarSrc}" alt="會員頭像" class="avatar-lg me-3" id="member-avatar">
		              </div>
		              <dl class="profile-list">
		                <dt>姓名:</dt><dd>${member.memName || '-'}</dd>
		                <dt>生日:</dt><dd>${member.memBirthday || '-'}</dd>
		                <dt>帳號:</dt><dd>${member.memAccount || '-'}</dd>
		                <dt>暱稱:</dt><dd>${member.memNickName || '-'}</dd>
		                <dt>信箱:</dt><dd>${member.memEmail || '-'}</dd>
		                <dt>地址:</dt><dd>${member.memAddr || '-'}</dd>
		                <dt>手機:</dt><dd>${member.memPhone || '-'}</dd>
		              </dl>
		              <div class="profile-edit-btns mt-3">
		                <button class="btn btn-main" id="editProfileBtn"><i class="bi bi-pencil"></i> 修改</button>
		              </div>
		            </div>
		          </div>
		          <div class="member-center-card mb-4 bg-white">
		            <div class="card-body py-4 px-4">
		              <div class="card-section-title mb-2">密碼重設</div>
		              <form id="resetPwdForm" autocomplete="off">
		                <input type="password" id="oldPassword" class="form-control mb-2" placeholder="輸入原密碼" required>
		                <input type="password" id="newPassword" class="form-control mb-2" placeholder="輸入新密碼" required>
		                <input type="password" id="newPasswordConfirm" class="form-control mb-3" placeholder="再次輸入新密碼" required>
		                <div class="d-flex mb-2" style="gap:10px;">
		                  <button type="submit" class="btn btn-main flex-fill">重設密碼</button>
		                </div>
		                <div id="resetPwdMsg" class="text-center mt-2"></div>
		              </form>
		            </div>
		          </div>
		        `;
		      } else {
		        return `
		          <div class="member-center-card mb-4 bg-white">
		            <div class="card-body py-4 px-4">
		              <div class="d-flex align-items-center mb-3">
		                <img src="${avatarSrc}" alt="會員頭像" class="avatar-lg me-3" id="member-avatar">
		              </div>
		              <form id="editProfileForm" autocomplete="off">
		                <dl class="profile-list">
		                    <dt>姓名:</dt><dd><input class="form-control edit-field" name="memName" value="${member.memName || ''}" required></dd>
		                    <dt>生日:</dt><dd>${member.memBirthday || '-'}</dd>
		                    <dt>帳號:</dt><dd>${member.memAccount || '-'}</dd>
		                    <dt>暱稱:</dt><dd><input class="form-control edit-field" name="memNickName" value="${member.memNickName || ''}"></dd>
		                    <dt>信箱:</dt><dd><input class="form-control edit-field" name="memEmail" type="email" value="${member.memEmail || ''}" required></dd>
		                    <dt>地址:</dt><dd><input class="form-control edit-field" name="memAddr" value="${member.memAddr || ''}"></dd>
		                    <dt>手機:</dt><dd><input class="form-control edit-field" name="memPhone" value="${member.memPhone || ''}"></dd>
		                </dl>
		                <div id="editProfileMsg" class="text-center mt-2"></div>
		                <div class="profile-edit-btns mt-3">
		                  <button type="submit" class="btn btn-main"><i class="bi bi-check-lg"></i> 儲存</button>
		                  <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn"><i class="bi bi-x-lg"></i> 取消</button>
		                </div>
		              </form>
		            </div>
		          </div>
		          <div class="member-center-card mb-4 bg-white">
		            <div class="card-body py-4 px-4">
		              <div class="card-section-title mb-2">密碼重設</div>
		              <form id="resetPwdForm" autocomplete="off">
		                <input type="password" id="oldPassword" class="form-control mb-2" placeholder="輸入原密碼" required>
		                <input type="password" id="newPassword" class="form-control mb-2" placeholder="輸入新密碼" required>
		                <input type="password" id="newPasswordConfirm" class="form-control mb-3" placeholder="再次輸入新密碼" required>
		                <div class="d-flex mb-2" style="gap:10px;">
		                  <button type="submit" class="btn btn-main flex-fill">重設密碼</button>
		                </div>
		                <div id="resetPwdMsg" class="text-center mt-2"></div>
		              </form>
		            </div>
		          </div>
		        `;
		      }
		    },
		    orders: async function(member) {
		      let html = `
		        <div class="member-center-card mb-4 bg-white">
		          <div class="card-body py-4 px-4">
		            <div class="card-section-title">歷史訂單</div>
		            <div class="table-responsive">
		              <table class="table align-middle mb-0">
		                <thead>
		                  <tr>
		                    <th>訂單編號</th>
		                    <th>訂購時間</th>
		                    <th>訂單狀態</th>
		                  </tr>
		                </thead>
		                <tbody id="orders-tbody">
		                  <tr><td colspan="4" class="text-center text-muted">資料載入中...</td></tr>
		                </tbody>
		              </table>
		            </div>
		          </div>
		        </div>
		      `;
		      document.getElementById('memberMainArea').innerHTML = html;

		      const jwt = localStorage.getItem('jwt');
		      const id = memberInfo.id;
		      try {
		        const res = await fetch(`/api/orders/member/${id}`, { 
		          method: 'GET',
		          headers: { 'Authorization': 'Bearer ' + jwt }
		        });
		        const orders = await res.json();

		        let rows = '';
		        if (orders && orders.length > 0) {
		          rows = orders.map(order => `
		            <tr>
		              <td>${order.orderNo}</td>
		              <td>${order.orderDatetime ? order.orderDatetime.replace('T', ' ').slice(0, 16) : ''}</td>
		              <td>${order.orderStatus || '-'}</td>
		            </tr>
		          `).join('');
		        } else {
		          rows = `<tr><td colspan="4" class="text-center text-muted">您目前尚未有任何訂單紀錄</td></tr>`;
		        }
		        document.getElementById('orders-tbody').innerHTML = rows;
		      } catch (e) {
		        document.getElementById('orders-tbody').innerHTML = `<tr><td colspan="4" class="text-danger text-center">資料取得失敗</td></tr>`;
		      }
		    },
		    coupons: async function(member) {
		      let html = `
		        <div class="member-center-card mb-4 bg-white">
		          <div class="card-body py-4 px-4">
		            <div class="card-section-title">我的優惠券</div>
		            <div class="table-responsive">
		              <table class="table align-middle mb-0">
		                <thead>
		                  <tr>
		                    <th>優惠券編號</th>
		                    <th>名稱</th>
		                    <th>序號</th>
		                    <th>適用範圍</th>
		                    <th>到期日</th>
		                    <th>狀態</th>
		                  </tr>
		                </thead>
		                <tbody id="coupons-tbody">
		                  <tr><td colspan="5" class="text-center text-muted">資料載入中...</td></tr>
		                </tbody>
		              </table>
		            </div>
		          </div>
		        </div>
		      `;
		      document.getElementById('memberMainArea').innerHTML = html;

		      const jwt = localStorage.getItem('jwt');
		      const id = memberInfo.id;
		      try {
		        const res = await fetch(`/api/coupon/member/${id}`, {
		          method: 'GET',
		          headers: { 'Authorization': 'Bearer ' + jwt }
		        });
		        const coupons = await res.json();

		        let rows = '';
		        if (coupons && coupons.length > 0) {
		          rows = coupons.map(coupon => `
		            <tr>
		              <td>${coupon.id || '-'}</td>
		              <td>${coupon.couName || '-'}</td>
		              <td>${coupon.couCode || '-'}</td>
		              <td>全部商品</td>
		              <td>${coupon.couUseEnd ? coupon.couUseEnd.replace('T', ' ').slice(0, 10) : '-'}</td>
		              <td>${coupon.couStatus === '1' ? '已使用' : '未使用'}</td>
		            </tr>
		          `).join('');
		        } else {
		          rows = `<tr><td colspan="5" class="text-center text-muted">您尚未擁有任何優惠券</td></tr>`;
		        }
		        document.getElementById('coupons-tbody').innerHTML = rows;
		      } catch (e) {
		        document.getElementById('coupons-tbody').innerHTML = `<tr><td colspan="5" class="text-danger text-center">資料取得失敗</td></tr>`;
		      }
		    },
		    collections: async function(member) {
		    	  let html = `
		    		    <div class="member-center-card mb-4 bg-white">
		    		      <div class="card-body py-4 px-4">
		    		        <div class="card-section-title">我的收藏</div>
		    		        <div class="table-responsive">
		    		          <table class="table align-middle mb-0">
		    		            <thead>
		    		              <tr>
		    		                <th>文章標題</th>
		    		                <th>收藏日期</th>
		    		              </tr>
		    		            </thead>
		    		            <tbody id="collections-tbody">
		    		              <tr><td colspan="2" class="text-center text-muted">資料載入中...</td></tr>
		    		            </tbody>
		    		          </table>
		    		        </div>
		    		      </div>
		    		    </div>
		    		  `;
		    		  document.getElementById('memberMainArea').innerHTML = html;

		    		  const jwt = localStorage.getItem('jwt');
		    		  const id = memberInfo.id;
		    		  try {
		    		    const res = await fetch(`/api/post-collect/member/${id}`, {
		    		      method: 'GET',
		    		      headers: { 'Authorization': 'Bearer ' + jwt }
		    		    });
		    		    const collections = await res.json();

		    		    let rows = '';
		    		    if (collections && collections.length > 0) {
		    		      rows = collections.map(item => `
		    		        <tr>
		    		          <td>${item.postTitle || '-'}</td>
		    		          <td>${item.pcollUpdate ? item.pcollUpdate.replace('T', ' ').slice(0, 10) : '-'}</td>
		    		        </tr>
		    		      `).join('');
		    		    } else {
		    		      rows = `<tr><td colspan="2" class="text-center text-muted">您尚未收藏任何文章</td></tr>`;
		    		    }
		    		    document.getElementById('collections-tbody').innerHTML = rows;
		    		  } catch (e) {
		    		    document.getElementById('collections-tbody').innerHTML =
		    		      `<tr><td colspan="2" class="text-danger text-center">資料取得失敗</td></tr>`;
		    		  }
		    		},
		  };

		  // 集中綁定所有動態事件
		  function profileViewHandler() {
		    const editBtn = document.getElementById('editProfileBtn');
		    if (editBtn) {
		      editBtn.removeEventListener('click', editBtn._handler);
		      const handler = () => renderTab('profile', true);
		      editBtn.addEventListener('click', handler);
		      editBtn._handler = handler;
		    }
		  }

		  function profileEditHandler() {
		    const cancelBtn = document.getElementById('cancelEditBtn');
		    if (cancelBtn) {
		      cancelBtn.removeEventListener('click', cancelBtn._handler);
		      const cancelHandler = () => renderTab('profile', false);
		      cancelBtn.addEventListener('click', cancelHandler);
		      cancelBtn._handler = cancelHandler;
		    }

		    const form = document.getElementById('editProfileForm');
		    if (!form) return;

		    form.removeEventListener('submit', form._handler);
		    const submitHandler = async function (e) {
		      e.preventDefault();

		      const msg = document.getElementById('editProfileMsg');
		      msg.textContent = '';

		      const formData = new FormData(form);
		      const payload = {};
		      ['memName','memNickName','memEmail','memAddr','memPhone'].forEach(key => {
		        payload[key] = formData.get(key) ? formData.get(key).trim() : '';
		      });

		      if (!payload.memName || !payload.memEmail) {
		        msg.style.color = '#b94040'; 
		        msg.textContent = '請填寫必填欄位';
		        return;
		      }

		      msg.textContent = '儲存中...'; 
		      msg.style.color = '#555';

		      try {
		        const res = await fetch(`/api/members/editProfile/${memberId}`, {
		          method: 'POST',
		          headers: {
		            'Content-Type': 'application/json',
		            'Authorization': 'Bearer ' + jwt
		          },
		          body: JSON.stringify(payload)
		        });
		        const result = await res.json();

		        if (!res.ok || !result.success) {
		          msg.style.color = '#b94040';
		          msg.textContent = result.message || '更新失敗，請稍後再試';
		          return;
		        }

		        Object.assign(window.memberProfile, payload);
		        msg.style.color = '#25945a';
		        msg.textContent = '更新成功';
		        setTimeout(() => renderTab('profile', false), 700);

		      } catch (e) {
		        msg.style.color = '#b94040';
		        msg.textContent = '更新失敗，請稍後再試';
		      }
		    };
		    form.addEventListener('submit', submitHandler);
		    form._handler = submitHandler;
		  }

		  function memPasswordReset() {
		    const form = document.getElementById('resetPwdForm');
		    if (!form) return;

		    form.removeEventListener('submit', form._handler);
		    const resetHandler = function (e) {
		      e.preventDefault();

		      const oldPassword = document.getElementById('oldPassword').value.trim();
		      const newPassword = document.getElementById('newPassword').value.trim();
		      const newPasswordConfirm = document.getElementById('newPasswordConfirm').value.trim();
		      const msg = document.getElementById('resetPwdMsg');

		      if (!oldPassword || !newPassword || !newPasswordConfirm) {
		        msg.textContent = '請填寫所有欄位';
		        msg.style.color = '#b94040';
		        return;
		      }
		      if (newPassword !== newPasswordConfirm) {
		        msg.textContent = '兩次輸入的新密碼不一致';
		        msg.style.color = '#b94040';
		        return;
		      }

		      const id = window.memberProfile.id;
		      if (!id) {
		        msg.textContent = '請重新登入以修改密碼';
		        msg.style.color = '#b94040';
		        return;
		      }

		      fetch('/api/members/reset-password', {
		        method: 'POST',
		        headers: {
		          'Content-Type': 'application/json',
		          'Authorization': 'Bearer ' + jwt
		        },
		        body: JSON.stringify({
		          id: id,
		          oldPassword: oldPassword,
		          newPassword: newPassword,
		          newPasswordConfirm: newPasswordConfirm
		        })
		      })
		      .then(res => res.json())
		      .then(data => {
		        if (data.success) {
		          alert('密碼已更新');
		          form.reset();
		        } else {
		          msg.style.color = '#b94040';
		          msg.textContent = data.message || '密碼重設失敗';
		        }
		      })
		      .catch(() => {
		        msg.style.color = '#b94040';
		        msg.textContent = '系統錯誤，請稍後再試';
		      });
		    };
		    form.addEventListener('submit', resetHandler);
		    form._handler = resetHandler;
		  }

		  async function renderTab(tab, editMode = false) {
		    // 更新網址欄的 tab 參數（不刷新頁面）
		    const url = new URL(window.location);
		    url.searchParams.set('tab', tab);
		    history.replaceState(null, '', url);

		    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
		    if (tab === 'profile') {
		      document.getElementById('memberMainArea').innerHTML = memberViews.profile(window.memberProfile, editMode);
		      if (editMode) profileEditHandler();
		      else profileViewHandler();
		      memPasswordReset();
		    } else {
		      const view = memberViews[tab];
		      if (typeof view === "function") {
		        if (view.constructor.name === "AsyncFunction") {
		          document.getElementById('memberMainArea').innerHTML = `<div style="text-align:center;padding:48px 0;">載入中...</div>`;
		          await view(window.memberProfile);
		        } else {
		          document.getElementById('memberMainArea').innerHTML = view(window.memberProfile);
		        }
		      } else {
		        document.getElementById('memberMainArea').innerHTML = view || '<div>找不到資料</div>';
		      }
		    }
		    initAllPageEvent();
		  }

		  function initAllPageEvent() {
		    profileViewHandler();
		    profileEditHandler();
		    memPasswordReset();
		  }

		  // 監聽 tab 按鈕點擊
		  document.querySelectorAll('.tab-btn').forEach(btn => {
		    btn.addEventListener('click', () => renderTab(btn.dataset.tab));
		  });

		  // 預設讀取 url tab 參數，沒有就 profile，使用 await 確保同步
		  const urlParams = new URLSearchParams(window.location.search);
		  const defaultTab = urlParams.get('tab') || 'profile';
		  await renderTab(defaultTab, false);
		});
	</script>
</body>
</html>
